<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="The green library documentation.">

    <title>sched.rs.html -- source</title>

    <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro:400,600'
          rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../main.css">

    <link rel="shortcut icon" href="http://www.rust-lang.org/favicon.ico">
    
</head>
<body>
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    

    <section class="sidebar">
        <a href='../../../../../../../../../green/index.html'><img src='http://www.rust-lang.org/logos/rust-logo-128x128-blk-v2.png' alt='' width='100'></a>
        
    </section>

    <nav class="sub">
        <form class="search-form js-only">
            <div class="search-container">
                <input class="search-input" name="search"
                       autocomplete="off"
                       placeholder="Click or press 'S' to search, '?' for more options..."
                       type="search">
            </div>
        </form>
    </nav>

    <section id='main' class="content source"><pre class='line-numbers'><span id='1'>   1</span>
<span id='2'>   2</span>
<span id='3'>   3</span>
<span id='4'>   4</span>
<span id='5'>   5</span>
<span id='6'>   6</span>
<span id='7'>   7</span>
<span id='8'>   8</span>
<span id='9'>   9</span>
<span id='10'>  10</span>
<span id='11'>  11</span>
<span id='12'>  12</span>
<span id='13'>  13</span>
<span id='14'>  14</span>
<span id='15'>  15</span>
<span id='16'>  16</span>
<span id='17'>  17</span>
<span id='18'>  18</span>
<span id='19'>  19</span>
<span id='20'>  20</span>
<span id='21'>  21</span>
<span id='22'>  22</span>
<span id='23'>  23</span>
<span id='24'>  24</span>
<span id='25'>  25</span>
<span id='26'>  26</span>
<span id='27'>  27</span>
<span id='28'>  28</span>
<span id='29'>  29</span>
<span id='30'>  30</span>
<span id='31'>  31</span>
<span id='32'>  32</span>
<span id='33'>  33</span>
<span id='34'>  34</span>
<span id='35'>  35</span>
<span id='36'>  36</span>
<span id='37'>  37</span>
<span id='38'>  38</span>
<span id='39'>  39</span>
<span id='40'>  40</span>
<span id='41'>  41</span>
<span id='42'>  42</span>
<span id='43'>  43</span>
<span id='44'>  44</span>
<span id='45'>  45</span>
<span id='46'>  46</span>
<span id='47'>  47</span>
<span id='48'>  48</span>
<span id='49'>  49</span>
<span id='50'>  50</span>
<span id='51'>  51</span>
<span id='52'>  52</span>
<span id='53'>  53</span>
<span id='54'>  54</span>
<span id='55'>  55</span>
<span id='56'>  56</span>
<span id='57'>  57</span>
<span id='58'>  58</span>
<span id='59'>  59</span>
<span id='60'>  60</span>
<span id='61'>  61</span>
<span id='62'>  62</span>
<span id='63'>  63</span>
<span id='64'>  64</span>
<span id='65'>  65</span>
<span id='66'>  66</span>
<span id='67'>  67</span>
<span id='68'>  68</span>
<span id='69'>  69</span>
<span id='70'>  70</span>
<span id='71'>  71</span>
<span id='72'>  72</span>
<span id='73'>  73</span>
<span id='74'>  74</span>
<span id='75'>  75</span>
<span id='76'>  76</span>
<span id='77'>  77</span>
<span id='78'>  78</span>
<span id='79'>  79</span>
<span id='80'>  80</span>
<span id='81'>  81</span>
<span id='82'>  82</span>
<span id='83'>  83</span>
<span id='84'>  84</span>
<span id='85'>  85</span>
<span id='86'>  86</span>
<span id='87'>  87</span>
<span id='88'>  88</span>
<span id='89'>  89</span>
<span id='90'>  90</span>
<span id='91'>  91</span>
<span id='92'>  92</span>
<span id='93'>  93</span>
<span id='94'>  94</span>
<span id='95'>  95</span>
<span id='96'>  96</span>
<span id='97'>  97</span>
<span id='98'>  98</span>
<span id='99'>  99</span>
<span id='100'> 100</span>
<span id='101'> 101</span>
<span id='102'> 102</span>
<span id='103'> 103</span>
<span id='104'> 104</span>
<span id='105'> 105</span>
<span id='106'> 106</span>
<span id='107'> 107</span>
<span id='108'> 108</span>
<span id='109'> 109</span>
<span id='110'> 110</span>
<span id='111'> 111</span>
<span id='112'> 112</span>
<span id='113'> 113</span>
<span id='114'> 114</span>
<span id='115'> 115</span>
<span id='116'> 116</span>
<span id='117'> 117</span>
<span id='118'> 118</span>
<span id='119'> 119</span>
<span id='120'> 120</span>
<span id='121'> 121</span>
<span id='122'> 122</span>
<span id='123'> 123</span>
<span id='124'> 124</span>
<span id='125'> 125</span>
<span id='126'> 126</span>
<span id='127'> 127</span>
<span id='128'> 128</span>
<span id='129'> 129</span>
<span id='130'> 130</span>
<span id='131'> 131</span>
<span id='132'> 132</span>
<span id='133'> 133</span>
<span id='134'> 134</span>
<span id='135'> 135</span>
<span id='136'> 136</span>
<span id='137'> 137</span>
<span id='138'> 138</span>
<span id='139'> 139</span>
<span id='140'> 140</span>
<span id='141'> 141</span>
<span id='142'> 142</span>
<span id='143'> 143</span>
<span id='144'> 144</span>
<span id='145'> 145</span>
<span id='146'> 146</span>
<span id='147'> 147</span>
<span id='148'> 148</span>
<span id='149'> 149</span>
<span id='150'> 150</span>
<span id='151'> 151</span>
<span id='152'> 152</span>
<span id='153'> 153</span>
<span id='154'> 154</span>
<span id='155'> 155</span>
<span id='156'> 156</span>
<span id='157'> 157</span>
<span id='158'> 158</span>
<span id='159'> 159</span>
<span id='160'> 160</span>
<span id='161'> 161</span>
<span id='162'> 162</span>
<span id='163'> 163</span>
<span id='164'> 164</span>
<span id='165'> 165</span>
<span id='166'> 166</span>
<span id='167'> 167</span>
<span id='168'> 168</span>
<span id='169'> 169</span>
<span id='170'> 170</span>
<span id='171'> 171</span>
<span id='172'> 172</span>
<span id='173'> 173</span>
<span id='174'> 174</span>
<span id='175'> 175</span>
<span id='176'> 176</span>
<span id='177'> 177</span>
<span id='178'> 178</span>
<span id='179'> 179</span>
<span id='180'> 180</span>
<span id='181'> 181</span>
<span id='182'> 182</span>
<span id='183'> 183</span>
<span id='184'> 184</span>
<span id='185'> 185</span>
<span id='186'> 186</span>
<span id='187'> 187</span>
<span id='188'> 188</span>
<span id='189'> 189</span>
<span id='190'> 190</span>
<span id='191'> 191</span>
<span id='192'> 192</span>
<span id='193'> 193</span>
<span id='194'> 194</span>
<span id='195'> 195</span>
<span id='196'> 196</span>
<span id='197'> 197</span>
<span id='198'> 198</span>
<span id='199'> 199</span>
<span id='200'> 200</span>
<span id='201'> 201</span>
<span id='202'> 202</span>
<span id='203'> 203</span>
<span id='204'> 204</span>
<span id='205'> 205</span>
<span id='206'> 206</span>
<span id='207'> 207</span>
<span id='208'> 208</span>
<span id='209'> 209</span>
<span id='210'> 210</span>
<span id='211'> 211</span>
<span id='212'> 212</span>
<span id='213'> 213</span>
<span id='214'> 214</span>
<span id='215'> 215</span>
<span id='216'> 216</span>
<span id='217'> 217</span>
<span id='218'> 218</span>
<span id='219'> 219</span>
<span id='220'> 220</span>
<span id='221'> 221</span>
<span id='222'> 222</span>
<span id='223'> 223</span>
<span id='224'> 224</span>
<span id='225'> 225</span>
<span id='226'> 226</span>
<span id='227'> 227</span>
<span id='228'> 228</span>
<span id='229'> 229</span>
<span id='230'> 230</span>
<span id='231'> 231</span>
<span id='232'> 232</span>
<span id='233'> 233</span>
<span id='234'> 234</span>
<span id='235'> 235</span>
<span id='236'> 236</span>
<span id='237'> 237</span>
<span id='238'> 238</span>
<span id='239'> 239</span>
<span id='240'> 240</span>
<span id='241'> 241</span>
<span id='242'> 242</span>
<span id='243'> 243</span>
<span id='244'> 244</span>
<span id='245'> 245</span>
<span id='246'> 246</span>
<span id='247'> 247</span>
<span id='248'> 248</span>
<span id='249'> 249</span>
<span id='250'> 250</span>
<span id='251'> 251</span>
<span id='252'> 252</span>
<span id='253'> 253</span>
<span id='254'> 254</span>
<span id='255'> 255</span>
<span id='256'> 256</span>
<span id='257'> 257</span>
<span id='258'> 258</span>
<span id='259'> 259</span>
<span id='260'> 260</span>
<span id='261'> 261</span>
<span id='262'> 262</span>
<span id='263'> 263</span>
<span id='264'> 264</span>
<span id='265'> 265</span>
<span id='266'> 266</span>
<span id='267'> 267</span>
<span id='268'> 268</span>
<span id='269'> 269</span>
<span id='270'> 270</span>
<span id='271'> 271</span>
<span id='272'> 272</span>
<span id='273'> 273</span>
<span id='274'> 274</span>
<span id='275'> 275</span>
<span id='276'> 276</span>
<span id='277'> 277</span>
<span id='278'> 278</span>
<span id='279'> 279</span>
<span id='280'> 280</span>
<span id='281'> 281</span>
<span id='282'> 282</span>
<span id='283'> 283</span>
<span id='284'> 284</span>
<span id='285'> 285</span>
<span id='286'> 286</span>
<span id='287'> 287</span>
<span id='288'> 288</span>
<span id='289'> 289</span>
<span id='290'> 290</span>
<span id='291'> 291</span>
<span id='292'> 292</span>
<span id='293'> 293</span>
<span id='294'> 294</span>
<span id='295'> 295</span>
<span id='296'> 296</span>
<span id='297'> 297</span>
<span id='298'> 298</span>
<span id='299'> 299</span>
<span id='300'> 300</span>
<span id='301'> 301</span>
<span id='302'> 302</span>
<span id='303'> 303</span>
<span id='304'> 304</span>
<span id='305'> 305</span>
<span id='306'> 306</span>
<span id='307'> 307</span>
<span id='308'> 308</span>
<span id='309'> 309</span>
<span id='310'> 310</span>
<span id='311'> 311</span>
<span id='312'> 312</span>
<span id='313'> 313</span>
<span id='314'> 314</span>
<span id='315'> 315</span>
<span id='316'> 316</span>
<span id='317'> 317</span>
<span id='318'> 318</span>
<span id='319'> 319</span>
<span id='320'> 320</span>
<span id='321'> 321</span>
<span id='322'> 322</span>
<span id='323'> 323</span>
<span id='324'> 324</span>
<span id='325'> 325</span>
<span id='326'> 326</span>
<span id='327'> 327</span>
<span id='328'> 328</span>
<span id='329'> 329</span>
<span id='330'> 330</span>
<span id='331'> 331</span>
<span id='332'> 332</span>
<span id='333'> 333</span>
<span id='334'> 334</span>
<span id='335'> 335</span>
<span id='336'> 336</span>
<span id='337'> 337</span>
<span id='338'> 338</span>
<span id='339'> 339</span>
<span id='340'> 340</span>
<span id='341'> 341</span>
<span id='342'> 342</span>
<span id='343'> 343</span>
<span id='344'> 344</span>
<span id='345'> 345</span>
<span id='346'> 346</span>
<span id='347'> 347</span>
<span id='348'> 348</span>
<span id='349'> 349</span>
<span id='350'> 350</span>
<span id='351'> 351</span>
<span id='352'> 352</span>
<span id='353'> 353</span>
<span id='354'> 354</span>
<span id='355'> 355</span>
<span id='356'> 356</span>
<span id='357'> 357</span>
<span id='358'> 358</span>
<span id='359'> 359</span>
<span id='360'> 360</span>
<span id='361'> 361</span>
<span id='362'> 362</span>
<span id='363'> 363</span>
<span id='364'> 364</span>
<span id='365'> 365</span>
<span id='366'> 366</span>
<span id='367'> 367</span>
<span id='368'> 368</span>
<span id='369'> 369</span>
<span id='370'> 370</span>
<span id='371'> 371</span>
<span id='372'> 372</span>
<span id='373'> 373</span>
<span id='374'> 374</span>
<span id='375'> 375</span>
<span id='376'> 376</span>
<span id='377'> 377</span>
<span id='378'> 378</span>
<span id='379'> 379</span>
<span id='380'> 380</span>
<span id='381'> 381</span>
<span id='382'> 382</span>
<span id='383'> 383</span>
<span id='384'> 384</span>
<span id='385'> 385</span>
<span id='386'> 386</span>
<span id='387'> 387</span>
<span id='388'> 388</span>
<span id='389'> 389</span>
<span id='390'> 390</span>
<span id='391'> 391</span>
<span id='392'> 392</span>
<span id='393'> 393</span>
<span id='394'> 394</span>
<span id='395'> 395</span>
<span id='396'> 396</span>
<span id='397'> 397</span>
<span id='398'> 398</span>
<span id='399'> 399</span>
<span id='400'> 400</span>
<span id='401'> 401</span>
<span id='402'> 402</span>
<span id='403'> 403</span>
<span id='404'> 404</span>
<span id='405'> 405</span>
<span id='406'> 406</span>
<span id='407'> 407</span>
<span id='408'> 408</span>
<span id='409'> 409</span>
<span id='410'> 410</span>
<span id='411'> 411</span>
<span id='412'> 412</span>
<span id='413'> 413</span>
<span id='414'> 414</span>
<span id='415'> 415</span>
<span id='416'> 416</span>
<span id='417'> 417</span>
<span id='418'> 418</span>
<span id='419'> 419</span>
<span id='420'> 420</span>
<span id='421'> 421</span>
<span id='422'> 422</span>
<span id='423'> 423</span>
<span id='424'> 424</span>
<span id='425'> 425</span>
<span id='426'> 426</span>
<span id='427'> 427</span>
<span id='428'> 428</span>
<span id='429'> 429</span>
<span id='430'> 430</span>
<span id='431'> 431</span>
<span id='432'> 432</span>
<span id='433'> 433</span>
<span id='434'> 434</span>
<span id='435'> 435</span>
<span id='436'> 436</span>
<span id='437'> 437</span>
<span id='438'> 438</span>
<span id='439'> 439</span>
<span id='440'> 440</span>
<span id='441'> 441</span>
<span id='442'> 442</span>
<span id='443'> 443</span>
<span id='444'> 444</span>
<span id='445'> 445</span>
<span id='446'> 446</span>
<span id='447'> 447</span>
<span id='448'> 448</span>
<span id='449'> 449</span>
<span id='450'> 450</span>
<span id='451'> 451</span>
<span id='452'> 452</span>
<span id='453'> 453</span>
<span id='454'> 454</span>
<span id='455'> 455</span>
<span id='456'> 456</span>
<span id='457'> 457</span>
<span id='458'> 458</span>
<span id='459'> 459</span>
<span id='460'> 460</span>
<span id='461'> 461</span>
<span id='462'> 462</span>
<span id='463'> 463</span>
<span id='464'> 464</span>
<span id='465'> 465</span>
<span id='466'> 466</span>
<span id='467'> 467</span>
<span id='468'> 468</span>
<span id='469'> 469</span>
<span id='470'> 470</span>
<span id='471'> 471</span>
<span id='472'> 472</span>
<span id='473'> 473</span>
<span id='474'> 474</span>
<span id='475'> 475</span>
<span id='476'> 476</span>
<span id='477'> 477</span>
<span id='478'> 478</span>
<span id='479'> 479</span>
<span id='480'> 480</span>
<span id='481'> 481</span>
<span id='482'> 482</span>
<span id='483'> 483</span>
<span id='484'> 484</span>
<span id='485'> 485</span>
<span id='486'> 486</span>
<span id='487'> 487</span>
<span id='488'> 488</span>
<span id='489'> 489</span>
<span id='490'> 490</span>
<span id='491'> 491</span>
<span id='492'> 492</span>
<span id='493'> 493</span>
<span id='494'> 494</span>
<span id='495'> 495</span>
<span id='496'> 496</span>
<span id='497'> 497</span>
<span id='498'> 498</span>
<span id='499'> 499</span>
<span id='500'> 500</span>
<span id='501'> 501</span>
<span id='502'> 502</span>
<span id='503'> 503</span>
<span id='504'> 504</span>
<span id='505'> 505</span>
<span id='506'> 506</span>
<span id='507'> 507</span>
<span id='508'> 508</span>
<span id='509'> 509</span>
<span id='510'> 510</span>
<span id='511'> 511</span>
<span id='512'> 512</span>
<span id='513'> 513</span>
<span id='514'> 514</span>
<span id='515'> 515</span>
<span id='516'> 516</span>
<span id='517'> 517</span>
<span id='518'> 518</span>
<span id='519'> 519</span>
<span id='520'> 520</span>
<span id='521'> 521</span>
<span id='522'> 522</span>
<span id='523'> 523</span>
<span id='524'> 524</span>
<span id='525'> 525</span>
<span id='526'> 526</span>
<span id='527'> 527</span>
<span id='528'> 528</span>
<span id='529'> 529</span>
<span id='530'> 530</span>
<span id='531'> 531</span>
<span id='532'> 532</span>
<span id='533'> 533</span>
<span id='534'> 534</span>
<span id='535'> 535</span>
<span id='536'> 536</span>
<span id='537'> 537</span>
<span id='538'> 538</span>
<span id='539'> 539</span>
<span id='540'> 540</span>
<span id='541'> 541</span>
<span id='542'> 542</span>
<span id='543'> 543</span>
<span id='544'> 544</span>
<span id='545'> 545</span>
<span id='546'> 546</span>
<span id='547'> 547</span>
<span id='548'> 548</span>
<span id='549'> 549</span>
<span id='550'> 550</span>
<span id='551'> 551</span>
<span id='552'> 552</span>
<span id='553'> 553</span>
<span id='554'> 554</span>
<span id='555'> 555</span>
<span id='556'> 556</span>
<span id='557'> 557</span>
<span id='558'> 558</span>
<span id='559'> 559</span>
<span id='560'> 560</span>
<span id='561'> 561</span>
<span id='562'> 562</span>
<span id='563'> 563</span>
<span id='564'> 564</span>
<span id='565'> 565</span>
<span id='566'> 566</span>
<span id='567'> 567</span>
<span id='568'> 568</span>
<span id='569'> 569</span>
<span id='570'> 570</span>
<span id='571'> 571</span>
<span id='572'> 572</span>
<span id='573'> 573</span>
<span id='574'> 574</span>
<span id='575'> 575</span>
<span id='576'> 576</span>
<span id='577'> 577</span>
<span id='578'> 578</span>
<span id='579'> 579</span>
<span id='580'> 580</span>
<span id='581'> 581</span>
<span id='582'> 582</span>
<span id='583'> 583</span>
<span id='584'> 584</span>
<span id='585'> 585</span>
<span id='586'> 586</span>
<span id='587'> 587</span>
<span id='588'> 588</span>
<span id='589'> 589</span>
<span id='590'> 590</span>
<span id='591'> 591</span>
<span id='592'> 592</span>
<span id='593'> 593</span>
<span id='594'> 594</span>
<span id='595'> 595</span>
<span id='596'> 596</span>
<span id='597'> 597</span>
<span id='598'> 598</span>
<span id='599'> 599</span>
<span id='600'> 600</span>
<span id='601'> 601</span>
<span id='602'> 602</span>
<span id='603'> 603</span>
<span id='604'> 604</span>
<span id='605'> 605</span>
<span id='606'> 606</span>
<span id='607'> 607</span>
<span id='608'> 608</span>
<span id='609'> 609</span>
<span id='610'> 610</span>
<span id='611'> 611</span>
<span id='612'> 612</span>
<span id='613'> 613</span>
<span id='614'> 614</span>
<span id='615'> 615</span>
<span id='616'> 616</span>
<span id='617'> 617</span>
<span id='618'> 618</span>
<span id='619'> 619</span>
<span id='620'> 620</span>
<span id='621'> 621</span>
<span id='622'> 622</span>
<span id='623'> 623</span>
<span id='624'> 624</span>
<span id='625'> 625</span>
<span id='626'> 626</span>
<span id='627'> 627</span>
<span id='628'> 628</span>
<span id='629'> 629</span>
<span id='630'> 630</span>
<span id='631'> 631</span>
<span id='632'> 632</span>
<span id='633'> 633</span>
<span id='634'> 634</span>
<span id='635'> 635</span>
<span id='636'> 636</span>
<span id='637'> 637</span>
<span id='638'> 638</span>
<span id='639'> 639</span>
<span id='640'> 640</span>
<span id='641'> 641</span>
<span id='642'> 642</span>
<span id='643'> 643</span>
<span id='644'> 644</span>
<span id='645'> 645</span>
<span id='646'> 646</span>
<span id='647'> 647</span>
<span id='648'> 648</span>
<span id='649'> 649</span>
<span id='650'> 650</span>
<span id='651'> 651</span>
<span id='652'> 652</span>
<span id='653'> 653</span>
<span id='654'> 654</span>
<span id='655'> 655</span>
<span id='656'> 656</span>
<span id='657'> 657</span>
<span id='658'> 658</span>
<span id='659'> 659</span>
<span id='660'> 660</span>
<span id='661'> 661</span>
<span id='662'> 662</span>
<span id='663'> 663</span>
<span id='664'> 664</span>
<span id='665'> 665</span>
<span id='666'> 666</span>
<span id='667'> 667</span>
<span id='668'> 668</span>
<span id='669'> 669</span>
<span id='670'> 670</span>
<span id='671'> 671</span>
<span id='672'> 672</span>
<span id='673'> 673</span>
<span id='674'> 674</span>
<span id='675'> 675</span>
<span id='676'> 676</span>
<span id='677'> 677</span>
<span id='678'> 678</span>
<span id='679'> 679</span>
<span id='680'> 680</span>
<span id='681'> 681</span>
<span id='682'> 682</span>
<span id='683'> 683</span>
<span id='684'> 684</span>
<span id='685'> 685</span>
<span id='686'> 686</span>
<span id='687'> 687</span>
<span id='688'> 688</span>
<span id='689'> 689</span>
<span id='690'> 690</span>
<span id='691'> 691</span>
<span id='692'> 692</span>
<span id='693'> 693</span>
<span id='694'> 694</span>
<span id='695'> 695</span>
<span id='696'> 696</span>
<span id='697'> 697</span>
<span id='698'> 698</span>
<span id='699'> 699</span>
<span id='700'> 700</span>
<span id='701'> 701</span>
<span id='702'> 702</span>
<span id='703'> 703</span>
<span id='704'> 704</span>
<span id='705'> 705</span>
<span id='706'> 706</span>
<span id='707'> 707</span>
<span id='708'> 708</span>
<span id='709'> 709</span>
<span id='710'> 710</span>
<span id='711'> 711</span>
<span id='712'> 712</span>
<span id='713'> 713</span>
<span id='714'> 714</span>
<span id='715'> 715</span>
<span id='716'> 716</span>
<span id='717'> 717</span>
<span id='718'> 718</span>
<span id='719'> 719</span>
<span id='720'> 720</span>
<span id='721'> 721</span>
<span id='722'> 722</span>
<span id='723'> 723</span>
<span id='724'> 724</span>
<span id='725'> 725</span>
<span id='726'> 726</span>
<span id='727'> 727</span>
<span id='728'> 728</span>
<span id='729'> 729</span>
<span id='730'> 730</span>
<span id='731'> 731</span>
<span id='732'> 732</span>
<span id='733'> 733</span>
<span id='734'> 734</span>
<span id='735'> 735</span>
<span id='736'> 736</span>
<span id='737'> 737</span>
<span id='738'> 738</span>
<span id='739'> 739</span>
<span id='740'> 740</span>
<span id='741'> 741</span>
<span id='742'> 742</span>
<span id='743'> 743</span>
<span id='744'> 744</span>
<span id='745'> 745</span>
<span id='746'> 746</span>
<span id='747'> 747</span>
<span id='748'> 748</span>
<span id='749'> 749</span>
<span id='750'> 750</span>
<span id='751'> 751</span>
<span id='752'> 752</span>
<span id='753'> 753</span>
<span id='754'> 754</span>
<span id='755'> 755</span>
<span id='756'> 756</span>
<span id='757'> 757</span>
<span id='758'> 758</span>
<span id='759'> 759</span>
<span id='760'> 760</span>
<span id='761'> 761</span>
<span id='762'> 762</span>
<span id='763'> 763</span>
<span id='764'> 764</span>
<span id='765'> 765</span>
<span id='766'> 766</span>
<span id='767'> 767</span>
<span id='768'> 768</span>
<span id='769'> 769</span>
<span id='770'> 770</span>
<span id='771'> 771</span>
<span id='772'> 772</span>
<span id='773'> 773</span>
<span id='774'> 774</span>
<span id='775'> 775</span>
<span id='776'> 776</span>
<span id='777'> 777</span>
<span id='778'> 778</span>
<span id='779'> 779</span>
<span id='780'> 780</span>
<span id='781'> 781</span>
<span id='782'> 782</span>
<span id='783'> 783</span>
<span id='784'> 784</span>
<span id='785'> 785</span>
<span id='786'> 786</span>
<span id='787'> 787</span>
<span id='788'> 788</span>
<span id='789'> 789</span>
<span id='790'> 790</span>
<span id='791'> 791</span>
<span id='792'> 792</span>
<span id='793'> 793</span>
<span id='794'> 794</span>
<span id='795'> 795</span>
<span id='796'> 796</span>
<span id='797'> 797</span>
<span id='798'> 798</span>
<span id='799'> 799</span>
<span id='800'> 800</span>
<span id='801'> 801</span>
<span id='802'> 802</span>
<span id='803'> 803</span>
<span id='804'> 804</span>
<span id='805'> 805</span>
<span id='806'> 806</span>
<span id='807'> 807</span>
<span id='808'> 808</span>
<span id='809'> 809</span>
<span id='810'> 810</span>
<span id='811'> 811</span>
<span id='812'> 812</span>
<span id='813'> 813</span>
<span id='814'> 814</span>
<span id='815'> 815</span>
<span id='816'> 816</span>
<span id='817'> 817</span>
<span id='818'> 818</span>
<span id='819'> 819</span>
<span id='820'> 820</span>
<span id='821'> 821</span>
<span id='822'> 822</span>
<span id='823'> 823</span>
<span id='824'> 824</span>
<span id='825'> 825</span>
<span id='826'> 826</span>
<span id='827'> 827</span>
<span id='828'> 828</span>
<span id='829'> 829</span>
<span id='830'> 830</span>
<span id='831'> 831</span>
<span id='832'> 832</span>
<span id='833'> 833</span>
<span id='834'> 834</span>
<span id='835'> 835</span>
<span id='836'> 836</span>
<span id='837'> 837</span>
<span id='838'> 838</span>
<span id='839'> 839</span>
<span id='840'> 840</span>
<span id='841'> 841</span>
<span id='842'> 842</span>
<span id='843'> 843</span>
<span id='844'> 844</span>
<span id='845'> 845</span>
<span id='846'> 846</span>
<span id='847'> 847</span>
<span id='848'> 848</span>
<span id='849'> 849</span>
<span id='850'> 850</span>
<span id='851'> 851</span>
<span id='852'> 852</span>
<span id='853'> 853</span>
<span id='854'> 854</span>
<span id='855'> 855</span>
<span id='856'> 856</span>
<span id='857'> 857</span>
<span id='858'> 858</span>
<span id='859'> 859</span>
<span id='860'> 860</span>
<span id='861'> 861</span>
<span id='862'> 862</span>
<span id='863'> 863</span>
<span id='864'> 864</span>
<span id='865'> 865</span>
<span id='866'> 866</span>
<span id='867'> 867</span>
<span id='868'> 868</span>
<span id='869'> 869</span>
<span id='870'> 870</span>
<span id='871'> 871</span>
<span id='872'> 872</span>
<span id='873'> 873</span>
<span id='874'> 874</span>
<span id='875'> 875</span>
<span id='876'> 876</span>
<span id='877'> 877</span>
<span id='878'> 878</span>
<span id='879'> 879</span>
<span id='880'> 880</span>
<span id='881'> 881</span>
<span id='882'> 882</span>
<span id='883'> 883</span>
<span id='884'> 884</span>
<span id='885'> 885</span>
<span id='886'> 886</span>
<span id='887'> 887</span>
<span id='888'> 888</span>
<span id='889'> 889</span>
<span id='890'> 890</span>
<span id='891'> 891</span>
<span id='892'> 892</span>
<span id='893'> 893</span>
<span id='894'> 894</span>
<span id='895'> 895</span>
<span id='896'> 896</span>
<span id='897'> 897</span>
<span id='898'> 898</span>
<span id='899'> 899</span>
<span id='900'> 900</span>
<span id='901'> 901</span>
<span id='902'> 902</span>
<span id='903'> 903</span>
<span id='904'> 904</span>
<span id='905'> 905</span>
<span id='906'> 906</span>
<span id='907'> 907</span>
<span id='908'> 908</span>
<span id='909'> 909</span>
<span id='910'> 910</span>
<span id='911'> 911</span>
<span id='912'> 912</span>
<span id='913'> 913</span>
<span id='914'> 914</span>
<span id='915'> 915</span>
<span id='916'> 916</span>
<span id='917'> 917</span>
<span id='918'> 918</span>
<span id='919'> 919</span>
<span id='920'> 920</span>
<span id='921'> 921</span>
<span id='922'> 922</span>
<span id='923'> 923</span>
<span id='924'> 924</span>
<span id='925'> 925</span>
<span id='926'> 926</span>
<span id='927'> 927</span>
<span id='928'> 928</span>
<span id='929'> 929</span>
<span id='930'> 930</span>
<span id='931'> 931</span>
<span id='932'> 932</span>
<span id='933'> 933</span>
<span id='934'> 934</span>
<span id='935'> 935</span>
<span id='936'> 936</span>
<span id='937'> 937</span>
<span id='938'> 938</span>
<span id='939'> 939</span>
<span id='940'> 940</span>
<span id='941'> 941</span>
<span id='942'> 942</span>
<span id='943'> 943</span>
<span id='944'> 944</span>
<span id='945'> 945</span>
<span id='946'> 946</span>
<span id='947'> 947</span>
<span id='948'> 948</span>
<span id='949'> 949</span>
<span id='950'> 950</span>
<span id='951'> 951</span>
<span id='952'> 952</span>
<span id='953'> 953</span>
<span id='954'> 954</span>
<span id='955'> 955</span>
<span id='956'> 956</span>
<span id='957'> 957</span>
<span id='958'> 958</span>
<span id='959'> 959</span>
<span id='960'> 960</span>
<span id='961'> 961</span>
<span id='962'> 962</span>
<span id='963'> 963</span>
<span id='964'> 964</span>
<span id='965'> 965</span>
<span id='966'> 966</span>
<span id='967'> 967</span>
<span id='968'> 968</span>
<span id='969'> 969</span>
<span id='970'> 970</span>
<span id='971'> 971</span>
<span id='972'> 972</span>
<span id='973'> 973</span>
<span id='974'> 974</span>
<span id='975'> 975</span>
<span id='976'> 976</span>
<span id='977'> 977</span>
<span id='978'> 978</span>
<span id='979'> 979</span>
<span id='980'> 980</span>
<span id='981'> 981</span>
<span id='982'> 982</span>
<span id='983'> 983</span>
<span id='984'> 984</span>
<span id='985'> 985</span>
<span id='986'> 986</span>
<span id='987'> 987</span>
<span id='988'> 988</span>
<span id='989'> 989</span>
<span id='990'> 990</span>
<span id='991'> 991</span>
<span id='992'> 992</span>
<span id='993'> 993</span>
<span id='994'> 994</span>
<span id='995'> 995</span>
<span id='996'> 996</span>
<span id='997'> 997</span>
<span id='998'> 998</span>
<span id='999'> 999</span>
<span id='1000'>1000</span>
<span id='1001'>1001</span>
<span id='1002'>1002</span>
<span id='1003'>1003</span>
<span id='1004'>1004</span>
<span id='1005'>1005</span>
<span id='1006'>1006</span>
<span id='1007'>1007</span>
<span id='1008'>1008</span>
<span id='1009'>1009</span>
<span id='1010'>1010</span>
<span id='1011'>1011</span>
<span id='1012'>1012</span>
<span id='1013'>1013</span>
<span id='1014'>1014</span>
<span id='1015'>1015</span>
<span id='1016'>1016</span>
<span id='1017'>1017</span>
<span id='1018'>1018</span>
<span id='1019'>1019</span>
<span id='1020'>1020</span>
<span id='1021'>1021</span>
<span id='1022'>1022</span>
<span id='1023'>1023</span>
<span id='1024'>1024</span>
<span id='1025'>1025</span>
<span id='1026'>1026</span>
<span id='1027'>1027</span>
<span id='1028'>1028</span>
<span id='1029'>1029</span>
<span id='1030'>1030</span>
<span id='1031'>1031</span>
<span id='1032'>1032</span>
<span id='1033'>1033</span>
<span id='1034'>1034</span>
<span id='1035'>1035</span>
<span id='1036'>1036</span>
<span id='1037'>1037</span>
<span id='1038'>1038</span>
<span id='1039'>1039</span>
<span id='1040'>1040</span>
<span id='1041'>1041</span>
<span id='1042'>1042</span>
<span id='1043'>1043</span>
<span id='1044'>1044</span>
<span id='1045'>1045</span>
<span id='1046'>1046</span>
<span id='1047'>1047</span>
<span id='1048'>1048</span>
<span id='1049'>1049</span>
<span id='1050'>1050</span>
<span id='1051'>1051</span>
<span id='1052'>1052</span>
<span id='1053'>1053</span>
<span id='1054'>1054</span>
<span id='1055'>1055</span>
<span id='1056'>1056</span>
<span id='1057'>1057</span>
<span id='1058'>1058</span>
<span id='1059'>1059</span>
<span id='1060'>1060</span>
<span id='1061'>1061</span>
<span id='1062'>1062</span>
<span id='1063'>1063</span>
<span id='1064'>1064</span>
<span id='1065'>1065</span>
<span id='1066'>1066</span>
<span id='1067'>1067</span>
<span id='1068'>1068</span>
<span id='1069'>1069</span>
<span id='1070'>1070</span>
<span id='1071'>1071</span>
<span id='1072'>1072</span>
<span id='1073'>1073</span>
<span id='1074'>1074</span>
<span id='1075'>1075</span>
<span id='1076'>1076</span>
<span id='1077'>1077</span>
<span id='1078'>1078</span>
<span id='1079'>1079</span>
<span id='1080'>1080</span>
<span id='1081'>1081</span>
<span id='1082'>1082</span>
<span id='1083'>1083</span>
<span id='1084'>1084</span>
<span id='1085'>1085</span>
<span id='1086'>1086</span>
<span id='1087'>1087</span>
<span id='1088'>1088</span>
<span id='1089'>1089</span>
<span id='1090'>1090</span>
<span id='1091'>1091</span>
<span id='1092'>1092</span>
<span id='1093'>1093</span>
<span id='1094'>1094</span>
<span id='1095'>1095</span>
<span id='1096'>1096</span>
<span id='1097'>1097</span>
<span id='1098'>1098</span>
<span id='1099'>1099</span>
<span id='1100'>1100</span>
<span id='1101'>1101</span>
<span id='1102'>1102</span>
<span id='1103'>1103</span>
<span id='1104'>1104</span>
<span id='1105'>1105</span>
<span id='1106'>1106</span>
<span id='1107'>1107</span>
<span id='1108'>1108</span>
<span id='1109'>1109</span>
<span id='1110'>1110</span>
<span id='1111'>1111</span>
<span id='1112'>1112</span>
<span id='1113'>1113</span>
<span id='1114'>1114</span>
<span id='1115'>1115</span>
<span id='1116'>1116</span>
<span id='1117'>1117</span>
<span id='1118'>1118</span>
<span id='1119'>1119</span>
<span id='1120'>1120</span>
<span id='1121'>1121</span>
<span id='1122'>1122</span>
<span id='1123'>1123</span>
<span id='1124'>1124</span>
<span id='1125'>1125</span>
<span id='1126'>1126</span>
<span id='1127'>1127</span>
<span id='1128'>1128</span>
<span id='1129'>1129</span>
<span id='1130'>1130</span>
<span id='1131'>1131</span>
<span id='1132'>1132</span>
<span id='1133'>1133</span>
<span id='1134'>1134</span>
<span id='1135'>1135</span>
<span id='1136'>1136</span>
<span id='1137'>1137</span>
<span id='1138'>1138</span>
<span id='1139'>1139</span>
<span id='1140'>1140</span>
<span id='1141'>1141</span>
<span id='1142'>1142</span>
<span id='1143'>1143</span>
<span id='1144'>1144</span>
<span id='1145'>1145</span>
<span id='1146'>1146</span>
<span id='1147'>1147</span>
<span id='1148'>1148</span>
<span id='1149'>1149</span>
<span id='1150'>1150</span>
<span id='1151'>1151</span>
<span id='1152'>1152</span>
<span id='1153'>1153</span>
<span id='1154'>1154</span>
<span id='1155'>1155</span>
<span id='1156'>1156</span>
<span id='1157'>1157</span>
<span id='1158'>1158</span>
<span id='1159'>1159</span>
<span id='1160'>1160</span>
<span id='1161'>1161</span>
<span id='1162'>1162</span>
<span id='1163'>1163</span>
<span id='1164'>1164</span>
<span id='1165'>1165</span>
<span id='1166'>1166</span>
<span id='1167'>1167</span>
<span id='1168'>1168</span>
<span id='1169'>1169</span>
<span id='1170'>1170</span>
<span id='1171'>1171</span>
<span id='1172'>1172</span>
<span id='1173'>1173</span>
<span id='1174'>1174</span>
<span id='1175'>1175</span>
<span id='1176'>1176</span>
<span id='1177'>1177</span>
<span id='1178'>1178</span>
<span id='1179'>1179</span>
<span id='1180'>1180</span>
<span id='1181'>1181</span>
<span id='1182'>1182</span>
<span id='1183'>1183</span>
<span id='1184'>1184</span>
<span id='1185'>1185</span>
<span id='1186'>1186</span>
<span id='1187'>1187</span>
<span id='1188'>1188</span>
<span id='1189'>1189</span>
<span id='1190'>1190</span>
<span id='1191'>1191</span>
<span id='1192'>1192</span>
<span id='1193'>1193</span>
<span id='1194'>1194</span>
<span id='1195'>1195</span>
<span id='1196'>1196</span>
<span id='1197'>1197</span>
<span id='1198'>1198</span>
<span id='1199'>1199</span>
<span id='1200'>1200</span>
<span id='1201'>1201</span>
<span id='1202'>1202</span>
<span id='1203'>1203</span>
<span id='1204'>1204</span>
<span id='1205'>1205</span>
<span id='1206'>1206</span>
<span id='1207'>1207</span>
<span id='1208'>1208</span>
<span id='1209'>1209</span>
<span id='1210'>1210</span>
<span id='1211'>1211</span>
<span id='1212'>1212</span>
<span id='1213'>1213</span>
<span id='1214'>1214</span>
<span id='1215'>1215</span>
<span id='1216'>1216</span>
<span id='1217'>1217</span>
<span id='1218'>1218</span>
<span id='1219'>1219</span>
<span id='1220'>1220</span>
<span id='1221'>1221</span>
<span id='1222'>1222</span>
<span id='1223'>1223</span>
<span id='1224'>1224</span>
<span id='1225'>1225</span>
<span id='1226'>1226</span>
<span id='1227'>1227</span>
<span id='1228'>1228</span>
<span id='1229'>1229</span>
<span id='1230'>1230</span>
<span id='1231'>1231</span>
<span id='1232'>1232</span>
<span id='1233'>1233</span>
<span id='1234'>1234</span>
<span id='1235'>1235</span>
<span id='1236'>1236</span>
<span id='1237'>1237</span>
<span id='1238'>1238</span>
<span id='1239'>1239</span>
<span id='1240'>1240</span>
<span id='1241'>1241</span>
<span id='1242'>1242</span>
<span id='1243'>1243</span>
<span id='1244'>1244</span>
<span id='1245'>1245</span>
<span id='1246'>1246</span>
<span id='1247'>1247</span>
<span id='1248'>1248</span>
<span id='1249'>1249</span>
<span id='1250'>1250</span>
<span id='1251'>1251</span>
<span id='1252'>1252</span>
<span id='1253'>1253</span>
<span id='1254'>1254</span>
<span id='1255'>1255</span>
<span id='1256'>1256</span>
<span id='1257'>1257</span>
<span id='1258'>1258</span>
<span id='1259'>1259</span>
<span id='1260'>1260</span>
<span id='1261'>1261</span>
<span id='1262'>1262</span>
<span id='1263'>1263</span>
<span id='1264'>1264</span>
<span id='1265'>1265</span>
<span id='1266'>1266</span>
<span id='1267'>1267</span>
<span id='1268'>1268</span>
<span id='1269'>1269</span>
<span id='1270'>1270</span>
<span id='1271'>1271</span>
<span id='1272'>1272</span>
<span id='1273'>1273</span>
<span id='1274'>1274</span>
<span id='1275'>1275</span>
<span id='1276'>1276</span>
<span id='1277'>1277</span>
<span id='1278'>1278</span>
<span id='1279'>1279</span>
<span id='1280'>1280</span>
<span id='1281'>1281</span>
<span id='1282'>1282</span>
<span id='1283'>1283</span>
<span id='1284'>1284</span>
<span id='1285'>1285</span>
<span id='1286'>1286</span>
<span id='1287'>1287</span>
<span id='1288'>1288</span>
<span id='1289'>1289</span>
<span id='1290'>1290</span>
<span id='1291'>1291</span>
<span id='1292'>1292</span>
<span id='1293'>1293</span>
<span id='1294'>1294</span>
<span id='1295'>1295</span>
<span id='1296'>1296</span>
<span id='1297'>1297</span>
<span id='1298'>1298</span>
<span id='1299'>1299</span>
<span id='1300'>1300</span>
<span id='1301'>1301</span>
<span id='1302'>1302</span>
<span id='1303'>1303</span>
<span id='1304'>1304</span>
<span id='1305'>1305</span>
<span id='1306'>1306</span>
<span id='1307'>1307</span>
<span id='1308'>1308</span>
<span id='1309'>1309</span>
<span id='1310'>1310</span>
<span id='1311'>1311</span>
<span id='1312'>1312</span>
<span id='1313'>1313</span>
<span id='1314'>1314</span>
<span id='1315'>1315</span>
<span id='1316'>1316</span>
<span id='1317'>1317</span>
<span id='1318'>1318</span>
<span id='1319'>1319</span>
<span id='1320'>1320</span>
<span id='1321'>1321</span>
<span id='1322'>1322</span>
<span id='1323'>1323</span>
<span id='1324'>1324</span>
<span id='1325'>1325</span>
<span id='1326'>1326</span>
<span id='1327'>1327</span>
<span id='1328'>1328</span>
<span id='1329'>1329</span>
<span id='1330'>1330</span>
<span id='1331'>1331</span>
<span id='1332'>1332</span>
<span id='1333'>1333</span>
<span id='1334'>1334</span>
<span id='1335'>1335</span>
<span id='1336'>1336</span>
<span id='1337'>1337</span>
<span id='1338'>1338</span>
<span id='1339'>1339</span>
<span id='1340'>1340</span>
<span id='1341'>1341</span>
<span id='1342'>1342</span>
<span id='1343'>1343</span>
<span id='1344'>1344</span>
<span id='1345'>1345</span>
<span id='1346'>1346</span>
<span id='1347'>1347</span>
<span id='1348'>1348</span>
<span id='1349'>1349</span>
<span id='1350'>1350</span>
<span id='1351'>1351</span>
<span id='1352'>1352</span>
<span id='1353'>1353</span>
<span id='1354'>1354</span>
<span id='1355'>1355</span>
<span id='1356'>1356</span>
<span id='1357'>1357</span>
<span id='1358'>1358</span>
<span id='1359'>1359</span>
<span id='1360'>1360</span>
<span id='1361'>1361</span>
<span id='1362'>1362</span>
<span id='1363'>1363</span>
<span id='1364'>1364</span>
<span id='1365'>1365</span>
<span id='1366'>1366</span>
<span id='1367'>1367</span>
<span id='1368'>1368</span>
<span id='1369'>1369</span>
<span id='1370'>1370</span>
<span id='1371'>1371</span>
<span id='1372'>1372</span>
<span id='1373'>1373</span>
<span id='1374'>1374</span>
<span id='1375'>1375</span>
<span id='1376'>1376</span>
<span id='1377'>1377</span>
<span id='1378'>1378</span>
<span id='1379'>1379</span>
<span id='1380'>1380</span>
<span id='1381'>1381</span>
<span id='1382'>1382</span>
<span id='1383'>1383</span>
<span id='1384'>1384</span>
<span id='1385'>1385</span>
<span id='1386'>1386</span>
<span id='1387'>1387</span>
<span id='1388'>1388</span>
<span id='1389'>1389</span>
<span id='1390'>1390</span>
<span id='1391'>1391</span>
<span id='1392'>1392</span>
<span id='1393'>1393</span>
<span id='1394'>1394</span>
<span id='1395'>1395</span>
<span id='1396'>1396</span>
<span id='1397'>1397</span>
<span id='1398'>1398</span>
<span id='1399'>1399</span>
<span id='1400'>1400</span>
<span id='1401'>1401</span>
<span id='1402'>1402</span>
<span id='1403'>1403</span>
<span id='1404'>1404</span>
<span id='1405'>1405</span>
<span id='1406'>1406</span>
<span id='1407'>1407</span>
<span id='1408'>1408</span>
<span id='1409'>1409</span>
<span id='1410'>1410</span>
<span id='1411'>1411</span>
<span id='1412'>1412</span>
<span id='1413'>1413</span>
<span id='1414'>1414</span>
<span id='1415'>1415</span>
<span id='1416'>1416</span>
<span id='1417'>1417</span>
<span id='1418'>1418</span>
<span id='1419'>1419</span>
<span id='1420'>1420</span>
<span id='1421'>1421</span>
<span id='1422'>1422</span>
<span id='1423'>1423</span>
<span id='1424'>1424</span>
<span id='1425'>1425</span>
<span id='1426'>1426</span>
<span id='1427'>1427</span>
<span id='1428'>1428</span>
<span id='1429'>1429</span>
<span id='1430'>1430</span>
<span id='1431'>1431</span>
<span id='1432'>1432</span>
<span id='1433'>1433</span>
<span id='1434'>1434</span>
<span id='1435'>1435</span>
<span id='1436'>1436</span>
<span id='1437'>1437</span>
<span id='1438'>1438</span>
<span id='1439'>1439</span>
<span id='1440'>1440</span>
<span id='1441'>1441</span>
<span id='1442'>1442</span>
<span id='1443'>1443</span>
<span id='1444'>1444</span>
<span id='1445'>1445</span>
<span id='1446'>1446</span>
<span id='1447'>1447</span>
<span id='1448'>1448</span>
<span id='1449'>1449</span>
<span id='1450'>1450</span>
<span id='1451'>1451</span>
<span id='1452'>1452</span>
<span id='1453'>1453</span>
<span id='1454'>1454</span>
<span id='1455'>1455</span>
<span id='1456'>1456</span>
<span id='1457'>1457</span>
<span id='1458'>1458</span>
<span id='1459'>1459</span>
<span id='1460'>1460</span>
<span id='1461'>1461</span>
<span id='1462'>1462</span>
<span id='1463'>1463</span>
<span id='1464'>1464</span>
<span id='1465'>1465</span>
<span id='1466'>1466</span>
<span id='1467'>1467</span>
<span id='1468'>1468</span>
<span id='1469'>1469</span>
<span id='1470'>1470</span>
<span id='1471'>1471</span>
<span id='1472'>1472</span>
<span id='1473'>1473</span>
<span id='1474'>1474</span>
<span id='1475'>1475</span>
<span id='1476'>1476</span>
<span id='1477'>1477</span>
<span id='1478'>1478</span>
<span id='1479'>1479</span>
<span id='1480'>1480</span>
<span id='1481'>1481</span>
<span id='1482'>1482</span>
<span id='1483'>1483</span>
<span id='1484'>1484</span>
<span id='1485'>1485</span>
<span id='1486'>1486</span>
<span id='1487'>1487</span>
<span id='1488'>1488</span>
<span id='1489'>1489</span>
<span id='1490'>1490</span>
<span id='1491'>1491</span>
<span id='1492'>1492</span>
<span id='1493'>1493</span>
<span id='1494'>1494</span>
<span id='1495'>1495</span>
<span id='1496'>1496</span>
<span id='1497'>1497</span>
<span id='1498'>1498</span>
<span id='1499'>1499</span>
<span id='1500'>1500</span>
<span id='1501'>1501</span>
<span id='1502'>1502</span>
<span id='1503'>1503</span>
<span id='1504'>1504</span>
<span id='1505'>1505</span>
<span id='1506'>1506</span>
<span id='1507'>1507</span>
<span id='1508'>1508</span>
<span id='1509'>1509</span>
<span id='1510'>1510</span>
<span id='1511'>1511</span>
<span id='1512'>1512</span>
<span id='1513'>1513</span>
<span id='1514'>1514</span>
<span id='1515'>1515</span>
<span id='1516'>1516</span>
<span id='1517'>1517</span>
<span id='1518'>1518</span>
<span id='1519'>1519</span>
<span id='1520'>1520</span>
<span id='1521'>1521</span>
<span id='1522'>1522</span>
<span id='1523'>1523</span>
<span id='1524'>1524</span>
<span id='1525'>1525</span>
<span id='1526'>1526</span>
<span id='1527'>1527</span>
<span id='1528'>1528</span>
<span id='1529'>1529</span>
<span id='1530'>1530</span>
<span id='1531'>1531</span>
<span id='1532'>1532</span>
<span id='1533'>1533</span>
<span id='1534'>1534</span>
<span id='1535'>1535</span>
<span id='1536'>1536</span>
<span id='1537'>1537</span>
<span id='1538'>1538</span>
<span id='1539'>1539</span>
</pre><pre class='rust '>
<span class='comment'>// Copyright 2013-2014 The Rust Project Developers. See the COPYRIGHT
// file at the top-level directory of this distribution and at
// http://rust-lang.org/COPYRIGHT.
//
// Licensed under the Apache License, Version 2.0 &lt;LICENSE-APACHE or
// http://www.apache.org/licenses/LICENSE-2.0&gt; or the MIT license
// &lt;LICENSE-MIT or http://opensource.org/licenses/MIT&gt;, at your
// option. This file may not be copied, modified, or distributed
// except according to those terms.

</span><span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>mem</span>;
<span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>rt</span>::<span class='ident'>local</span>::<span class='ident'>Local</span>;
<span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>rt</span>::<span class='ident'>mutex</span>::<span class='ident'>NativeMutex</span>;
<span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>rt</span>::<span class='ident'>rtio</span>::{<span class='ident'>RemoteCallback</span>, <span class='ident'>PausableIdleCallback</span>, <span class='ident'>Callback</span>, <span class='ident'>EventLoop</span>};
<span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>rt</span>::<span class='ident'>task</span>::<span class='ident'>BlockedTask</span>;
<span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>rt</span>::<span class='ident'>task</span>::<span class='ident'>Task</span>;
<span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>sync</span>::<span class='ident'>deque</span>;
<span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>raw</span>;

<span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>rand</span>::{<span class='ident'>XorShiftRng</span>, <span class='ident'>Rng</span>, <span class='ident'>Rand</span>};

<span class='kw'>use</span> <span class='ident'>TaskState</span>;
<span class='kw'>use</span> <span class='ident'>context</span>::<span class='ident'>Context</span>;
<span class='kw'>use</span> <span class='ident'>coroutine</span>::<span class='ident'>Coroutine</span>;
<span class='kw'>use</span> <span class='ident'>sleeper_list</span>::<span class='ident'>SleeperList</span>;
<span class='kw'>use</span> <span class='ident'>stack</span>::<span class='ident'>StackPool</span>;
<span class='kw'>use</span> <span class='ident'>task</span>::{<span class='ident'>TypeSched</span>, <span class='ident'>GreenTask</span>, <span class='ident'>HomeSched</span>, <span class='ident'>AnySched</span>};
<span class='kw'>use</span> <span class='ident'>msgq</span> <span class='op'>=</span> <span class='ident'>message_queue</span>;

<span class='doccomment'>/// A scheduler is responsible for coordinating the execution of Tasks</span>
<span class='doccomment'>/// on a single thread. The scheduler runs inside a slightly modified</span>
<span class='doccomment'>/// Rust Task. When not running this task is stored in the scheduler</span>
<span class='doccomment'>/// struct. The scheduler struct acts like a baton, all scheduling</span>
<span class='doccomment'>/// actions are transfers of the baton.</span>
<span class='doccomment'>///</span>
<span class='doccomment'>/// FIXME: This creates too many callbacks to run_sched_once, resulting</span>
<span class='doccomment'>/// in too much allocation and too many events.</span>
<span class='kw'>pub</span> <span class='kw'>struct</span> <span class='ident'>Scheduler</span> {
    <span class='doccomment'>/// ID number of the pool that this scheduler is a member of. When</span>
    <span class='doccomment'>/// reawakening green tasks, this is used to ensure that tasks aren&#39;t</span>
    <span class='doccomment'>/// reawoken on the wrong pool of schedulers.</span>
    <span class='kw'>pub</span> <span class='ident'>pool_id</span>: <span class='ident'>uint</span>,
    <span class='doccomment'>/// The pool of stacks that this scheduler has cached</span>
    <span class='kw'>pub</span> <span class='ident'>stack_pool</span>: <span class='ident'>StackPool</span>,
    <span class='doccomment'>/// Bookkeeping for the number of tasks which are currently running around</span>
    <span class='doccomment'>/// inside this pool of schedulers</span>
    <span class='kw'>pub</span> <span class='ident'>task_state</span>: <span class='ident'>TaskState</span>,
    <span class='doccomment'>/// There are N work queues, one per scheduler.</span>
    <span class='ident'>work_queue</span>: <span class='ident'>deque</span>::<span class='ident'>Worker</span><span class='op'>&lt;</span><span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;&gt;</span>,
    <span class='doccomment'>/// Work queues for the other schedulers. These are created by</span>
    <span class='doccomment'>/// cloning the core work queues.</span>
    <span class='ident'>work_queues</span>: <span class='ident'>Vec</span><span class='op'>&lt;</span><span class='ident'>deque</span>::<span class='ident'>Stealer</span><span class='op'>&lt;</span><span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;&gt;</span><span class='op'>&gt;</span>,
    <span class='doccomment'>/// The queue of incoming messages from other schedulers.</span>
    <span class='doccomment'>/// These are enqueued by SchedHandles after which a remote callback</span>
    <span class='doccomment'>/// is triggered to handle the message.</span>
    <span class='ident'>message_queue</span>: <span class='ident'>msgq</span>::<span class='ident'>Consumer</span><span class='op'>&lt;</span><span class='ident'>SchedMessage</span><span class='op'>&gt;</span>,
    <span class='doccomment'>/// Producer used to clone sched handles from</span>
    <span class='ident'>message_producer</span>: <span class='ident'>msgq</span>::<span class='ident'>Producer</span><span class='op'>&lt;</span><span class='ident'>SchedMessage</span><span class='op'>&gt;</span>,
    <span class='doccomment'>/// A shared list of sleeping schedulers. We&#39;ll use this to wake</span>
    <span class='doccomment'>/// up schedulers when pushing work onto the work queue.</span>
    <span class='ident'>sleeper_list</span>: <span class='ident'>SleeperList</span>,
    <span class='doccomment'>/// Indicates that we have previously pushed a handle onto the</span>
    <span class='doccomment'>/// SleeperList but have not yet received the Wake message.</span>
    <span class='doccomment'>/// Being `true` does not necessarily mean that the scheduler is</span>
    <span class='doccomment'>/// not active since there are multiple event sources that may</span>
    <span class='doccomment'>/// wake the scheduler. It just prevents the scheduler from pushing</span>
    <span class='doccomment'>/// multiple handles onto the sleeper list.</span>
    <span class='ident'>sleepy</span>: <span class='ident'>bool</span>,
    <span class='doccomment'>/// A flag to indicate we&#39;ve received the shutdown message and should</span>
    <span class='doccomment'>/// no longer try to go to sleep, but exit instead.</span>
    <span class='ident'>no_sleep</span>: <span class='ident'>bool</span>,
    <span class='doccomment'>/// The scheduler runs on a special task. When it is not running</span>
    <span class='doccomment'>/// it is stored here instead of the work queue.</span>
    <span class='ident'>sched_task</span>: <span class='prelude-ty'>Option</span><span class='op'>&lt;</span><span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;&gt;</span>,
    <span class='doccomment'>/// An action performed after a context switch on behalf of the</span>
    <span class='doccomment'>/// code running before the context switch</span>
    <span class='ident'>cleanup_job</span>: <span class='prelude-ty'>Option</span><span class='op'>&lt;</span><span class='ident'>CleanupJob</span><span class='op'>&gt;</span>,
    <span class='doccomment'>/// If the scheduler shouldn&#39;t run some tasks, a friend to send</span>
    <span class='doccomment'>/// them to.</span>
    <span class='ident'>friend_handle</span>: <span class='prelude-ty'>Option</span><span class='op'>&lt;</span><span class='ident'>SchedHandle</span><span class='op'>&gt;</span>,
    <span class='doccomment'>/// Should this scheduler run any task, or only pinned tasks?</span>
    <span class='ident'>run_anything</span>: <span class='ident'>bool</span>,
    <span class='doccomment'>/// A fast XorShift rng for scheduler use</span>
    <span class='ident'>rng</span>: <span class='ident'>XorShiftRng</span>,
    <span class='doccomment'>/// A toggleable idle callback</span>
    <span class='ident'>idle_callback</span>: <span class='prelude-ty'>Option</span><span class='op'>&lt;</span><span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>PausableIdleCallback</span> <span class='op'>+</span> <span class='ident'>Send</span><span class='op'>&gt;&gt;</span>,
    <span class='doccomment'>/// A countdown that starts at a random value and is decremented</span>
    <span class='doccomment'>/// every time a yield check is performed. When it hits 0 a task</span>
    <span class='doccomment'>/// will yield.</span>
    <span class='ident'>yield_check_count</span>: <span class='ident'>uint</span>,
    <span class='doccomment'>/// A flag to tell the scheduler loop it needs to do some stealing</span>
    <span class='doccomment'>/// in order to introduce randomness as part of a yield</span>
    <span class='ident'>steal_for_yield</span>: <span class='ident'>bool</span>,<span class='comment'>

    // n.b. currently destructors of an object are run in top-to-bottom in order
    //      of field declaration. Due to its nature, the pausable idle callback
    //      must have some sort of handle to the event loop, so it needs to get
    //      destroyed before the event loop itself. For this reason, we destroy
    //      the event loop last to ensure that any unsafe references to it are
    //      destroyed before it&#39;s actually destroyed.

    </span><span class='doccomment'>/// The event loop used to drive the scheduler and perform I/O</span>
    <span class='kw'>pub</span> <span class='ident'>event_loop</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>EventLoop</span> <span class='op'>+</span> <span class='ident'>Send</span><span class='op'>&gt;</span>,
}

<span class='doccomment'>/// An indication of how hard to work on a given operation, the difference</span>
<span class='doccomment'>/// mainly being whether memory is synchronized or not</span>
<span class='attribute'>#[<span class='ident'>deriving</span>(<span class='ident'>PartialEq</span>)]</span>
<span class='kw'>enum</span> <span class='ident'>EffortLevel</span> {
    <span class='ident'>DontTryTooHard</span>,
    <span class='ident'>GiveItYourBest</span>
}

<span class='kw'>static</span> <span class='ident'>MAX_YIELD_CHECKS</span>: <span class='ident'>uint</span> <span class='op'>=</span> <span class='number'>20000</span>;

<span class='kw'>fn</span> <span class='ident'>reset_yield_check</span>(<span class='ident'>rng</span>: <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>XorShiftRng</span>) <span class='op'>-&gt;</span> <span class='ident'>uint</span> {
    <span class='kw'>let</span> <span class='ident'>r</span>: <span class='ident'>uint</span> <span class='op'>=</span> <span class='ident'>Rand</span>::<span class='ident'>rand</span>(<span class='ident'>rng</span>);
    <span class='ident'>r</span> <span class='op'>%</span> <span class='ident'>MAX_YIELD_CHECKS</span> <span class='op'>+</span> <span class='number'>1</span>
}

<span class='kw'>impl</span> <span class='ident'>Scheduler</span> {<span class='comment'>

    // * Initialization Functions

    </span><span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>new</span>(<span class='ident'>pool_id</span>: <span class='ident'>uint</span>,
               <span class='ident'>event_loop</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>EventLoop</span> <span class='op'>+</span> <span class='ident'>Send</span><span class='op'>&gt;</span>,
               <span class='ident'>work_queue</span>: <span class='ident'>deque</span>::<span class='ident'>Worker</span><span class='op'>&lt;</span><span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;&gt;</span>,
               <span class='ident'>work_queues</span>: <span class='ident'>Vec</span><span class='op'>&lt;</span><span class='ident'>deque</span>::<span class='ident'>Stealer</span><span class='op'>&lt;</span><span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;&gt;</span><span class='op'>&gt;</span>,
               <span class='ident'>sleeper_list</span>: <span class='ident'>SleeperList</span>,
               <span class='ident'>state</span>: <span class='ident'>TaskState</span>)
        <span class='op'>-&gt;</span> <span class='ident'>Scheduler</span> {

        <span class='ident'>Scheduler</span>::<span class='ident'>new_special</span>(<span class='ident'>pool_id</span>, <span class='ident'>event_loop</span>, <span class='ident'>work_queue</span>, <span class='ident'>work_queues</span>,
                               <span class='ident'>sleeper_list</span>, <span class='boolval'>true</span>, <span class='prelude-val'>None</span>, <span class='ident'>state</span>)

    }

    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>new_special</span>(<span class='ident'>pool_id</span>: <span class='ident'>uint</span>,
                       <span class='ident'>event_loop</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>EventLoop</span> <span class='op'>+</span> <span class='ident'>Send</span><span class='op'>&gt;</span>,
                       <span class='ident'>work_queue</span>: <span class='ident'>deque</span>::<span class='ident'>Worker</span><span class='op'>&lt;</span><span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;&gt;</span>,
                       <span class='ident'>work_queues</span>: <span class='ident'>Vec</span><span class='op'>&lt;</span><span class='ident'>deque</span>::<span class='ident'>Stealer</span><span class='op'>&lt;</span><span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;&gt;</span><span class='op'>&gt;</span>,
                       <span class='ident'>sleeper_list</span>: <span class='ident'>SleeperList</span>,
                       <span class='ident'>run_anything</span>: <span class='ident'>bool</span>,
                       <span class='ident'>friend</span>: <span class='prelude-ty'>Option</span><span class='op'>&lt;</span><span class='ident'>SchedHandle</span><span class='op'>&gt;</span>,
                       <span class='ident'>state</span>: <span class='ident'>TaskState</span>)
        <span class='op'>-&gt;</span> <span class='ident'>Scheduler</span> {

        <span class='kw'>let</span> (<span class='ident'>consumer</span>, <span class='ident'>producer</span>) <span class='op'>=</span> <span class='ident'>msgq</span>::<span class='ident'>queue</span>();
        <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>sched</span> <span class='op'>=</span> <span class='ident'>Scheduler</span> {
            <span class='ident'>pool_id</span>: <span class='ident'>pool_id</span>,
            <span class='ident'>sleeper_list</span>: <span class='ident'>sleeper_list</span>,
            <span class='ident'>message_queue</span>: <span class='ident'>consumer</span>,
            <span class='ident'>message_producer</span>: <span class='ident'>producer</span>,
            <span class='ident'>sleepy</span>: <span class='boolval'>false</span>,
            <span class='ident'>no_sleep</span>: <span class='boolval'>false</span>,
            <span class='ident'>event_loop</span>: <span class='ident'>event_loop</span>,
            <span class='ident'>work_queue</span>: <span class='ident'>work_queue</span>,
            <span class='ident'>work_queues</span>: <span class='ident'>work_queues</span>,
            <span class='ident'>stack_pool</span>: <span class='ident'>StackPool</span>::<span class='ident'>new</span>(),
            <span class='ident'>sched_task</span>: <span class='prelude-val'>None</span>,
            <span class='ident'>cleanup_job</span>: <span class='prelude-val'>None</span>,
            <span class='ident'>run_anything</span>: <span class='ident'>run_anything</span>,
            <span class='ident'>friend_handle</span>: <span class='ident'>friend</span>,
            <span class='ident'>rng</span>: <span class='ident'>new_sched_rng</span>(),
            <span class='ident'>idle_callback</span>: <span class='prelude-val'>None</span>,
            <span class='ident'>yield_check_count</span>: <span class='number'>0</span>,
            <span class='ident'>steal_for_yield</span>: <span class='boolval'>false</span>,
            <span class='ident'>task_state</span>: <span class='ident'>state</span>,
        };

        <span class='ident'>sched</span>.<span class='ident'>yield_check_count</span> <span class='op'>=</span> <span class='ident'>reset_yield_check</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>sched</span>.<span class='ident'>rng</span>);

        <span class='kw'>return</span> <span class='ident'>sched</span>;
    }<span class='comment'>

    // FIXME: This may eventually need to be refactored so that
    // the scheduler itself doesn&#39;t have to call event_loop.run.
    // That will be important for embedding the runtime into external
    // event loops.

    // Take a main task to run, and a scheduler to run it in. Create a
    // scheduler task and bootstrap into it.
    </span><span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>bootstrap</span>(<span class='kw-2'>mut</span> <span class='kw-2'>~</span><span class='self'>self</span>) {<span class='comment'>

        // Build an Idle callback.
        </span><span class='kw'>let</span> <span class='ident'>cb</span> <span class='op'>=</span> <span class='kw'>box</span> <span class='ident'>SchedRunner</span> <span class='kw'>as</span> <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>Callback</span> <span class='op'>+</span> <span class='ident'>Send</span><span class='op'>&gt;</span>;
        <span class='self'>self</span>.<span class='ident'>idle_callback</span> <span class='op'>=</span> <span class='prelude-val'>Some</span>(<span class='self'>self</span>.<span class='ident'>event_loop</span>.<span class='ident'>pausable_idle_callback</span>(<span class='ident'>cb</span>));<span class='comment'>

        // Create a task for the scheduler with an empty context.
        </span><span class='kw'>let</span> <span class='ident'>sched_task</span> <span class='op'>=</span> <span class='ident'>GreenTask</span>::<span class='ident'>new_typed</span>(<span class='prelude-val'>Some</span>(<span class='ident'>Coroutine</span>::<span class='ident'>empty</span>()),
                                              <span class='ident'>TypeSched</span>);<span class='comment'>

        // Before starting our first task, make sure the idle callback
        // is active. As we do not start in the sleep state this is
        // important.
        </span><span class='self'>self</span>.<span class='ident'>idle_callback</span>.<span class='ident'>get_mut_ref</span>().<span class='ident'>resume</span>();<span class='comment'>

        // Now, as far as all the scheduler state is concerned, we are inside
        // the &quot;scheduler&quot; context. The scheduler immediately hands over control
        // to the event loop, and this will only exit once the event loop no
        // longer has any references (handles or I/O objects).
        </span><span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;starting scheduler {}&quot;</span>, <span class='self'>self</span>.<span class='ident'>sched_id</span>());
        <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>sched_task</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>run</span>(<span class='ident'>sched_task</span>);<span class='comment'>

        // Close the idle callback.
        </span><span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>sched</span> <span class='op'>=</span> <span class='ident'>sched_task</span>.<span class='ident'>sched</span>.<span class='ident'>take_unwrap</span>();
        <span class='ident'>sched</span>.<span class='ident'>idle_callback</span>.<span class='ident'>take</span>();<span class='comment'>
        // Make one go through the loop to run the close callback.
        </span><span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>stask</span> <span class='op'>=</span> <span class='ident'>sched</span>.<span class='ident'>run</span>(<span class='ident'>sched_task</span>);<span class='comment'>

        // Now that we are done with the scheduler, clean up the
        // scheduler task. Do so by removing it from TLS and manually
        // cleaning up the memory it uses. As we didn&#39;t actually call
        // task.run() on the scheduler task we never get through all
        // the cleanup code it runs.
        </span><span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;stopping scheduler {}&quot;</span>, <span class='ident'>stask</span>.<span class='ident'>sched</span>.<span class='ident'>get_ref</span>().<span class='ident'>sched_id</span>());<span class='comment'>

        // Should not have any messages
        </span><span class='kw'>let</span> <span class='ident'>message</span> <span class='op'>=</span> <span class='ident'>stask</span>.<span class='ident'>sched</span>.<span class='ident'>get_mut_ref</span>().<span class='ident'>message_queue</span>.<span class='ident'>pop</span>();
        <span class='macro'>rtassert</span><span class='macro'>!</span>(<span class='kw'>match</span> <span class='ident'>message</span> { <span class='ident'>msgq</span>::<span class='ident'>Empty</span> <span class='op'>=&gt;</span> <span class='boolval'>true</span>, _ <span class='op'>=&gt;</span> <span class='boolval'>false</span> });

        <span class='ident'>stask</span>.<span class='ident'>task</span>.<span class='ident'>get_mut_ref</span>().<span class='ident'>destroyed</span> <span class='op'>=</span> <span class='boolval'>true</span>;
    }<span class='comment'>

    // This does not return a scheduler, as the scheduler is placed
    // inside the task.
    </span><span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>run</span>(<span class='kw-2'>mut</span> <span class='kw-2'>~</span><span class='self'>self</span>, <span class='ident'>stask</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>) <span class='op'>-&gt;</span> <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span> {<span class='comment'>

        // This is unsafe because we need to place the scheduler, with
        // the event_loop inside, inside our task. But we still need a
        // mutable reference to the event_loop to give it the &quot;run&quot;
        // command.
        </span><span class='kw'>unsafe</span> {
            <span class='kw'>let</span> <span class='ident'>event_loop</span>: <span class='op'>*</span><span class='kw-2'>mut</span> <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>EventLoop</span> <span class='op'>+</span> <span class='ident'>Send</span><span class='op'>&gt;</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>.<span class='ident'>event_loop</span>;<span class='comment'>
            // Our scheduler must be in the task before the event loop
            // is started.
            </span><span class='ident'>stask</span>.<span class='ident'>put_with_sched</span>(<span class='self'>self</span>);
            (<span class='op'>*</span><span class='ident'>event_loop</span>).<span class='ident'>run</span>();
        }<span class='comment'>

        //  This is a serious code smell, but this function could be done away
        //  with if necessary. The ownership of `stask` was transferred into
        //  local storage just before the event loop ran, so it is possible to
        //  transmute `stask` as a uint across the running of the event loop to
        //  re-acquire ownership here.
        //
        // This would involve removing the Task from TLS, removing the runtime,
        // forgetting the runtime, and then putting the task into `stask`. For
        // now, because we have `GreenTask::convert`, I chose to take this
        // method for cleanliness. This function is *not* a fundamental reason
        // why this function should exist.
        </span><span class='ident'>GreenTask</span>::<span class='ident'>convert</span>(<span class='ident'>Local</span>::<span class='ident'>take</span>())
    }<span class='comment'>

    // * Execution Functions - Core Loop Logic

    // This function is run from the idle callback on the uv loop, indicating
    // that there are no I/O events pending. When this function returns, we will
    // fall back to epoll() in the uv event loop, waiting for more things to
    // happen. We may come right back off epoll() if the idle callback is still
    // active, in which case we&#39;re truly just polling to see if I/O events are
    // complete.
    //
    // The model for this function is to execute as much work as possible while
    // still fairly considering I/O tasks. Falling back to epoll() frequently is
    // often quite expensive, so we attempt to avoid it as much as possible. If
    // we have any active I/O on the event loop, then we&#39;re forced to fall back
    // to epoll() in order to provide fairness, but as long as we&#39;re doing work
    // and there&#39;s no active I/O, we can continue to do work.
    //
    // If we try really hard to do some work, but no work is available to be
    // done, then we fall back to epoll() to block this thread waiting for more
    // work (instead of busy waiting).
    </span><span class='kw'>fn</span> <span class='ident'>run_sched_once</span>(<span class='kw-2'>mut</span> <span class='kw-2'>~</span><span class='self'>self</span>, <span class='ident'>stask</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>) {<span class='comment'>
        // Make sure that we&#39;re not lying in that the `stask` argument is indeed
        // the scheduler task for this scheduler.
        </span><span class='macro'>assert</span><span class='macro'>!</span>(<span class='self'>self</span>.<span class='ident'>sched_task</span>.<span class='ident'>is_none</span>());<span class='comment'>

        // Assume that we need to continue idling unless we reach the
        // end of this function without performing an action.
        </span><span class='self'>self</span>.<span class='ident'>idle_callback</span>.<span class='ident'>get_mut_ref</span>().<span class='ident'>resume</span>();<span class='comment'>

        // First we check for scheduler messages, these are higher
        // priority than regular tasks.
        </span><span class='kw'>let</span> (<span class='kw-2'>mut</span> <span class='ident'>sched</span>, <span class='kw-2'>mut</span> <span class='ident'>stask</span>, <span class='kw-2'>mut</span> <span class='ident'>did_work</span>) <span class='op'>=</span>
            <span class='self'>self</span>.<span class='ident'>interpret_message_queue</span>(<span class='ident'>stask</span>, <span class='ident'>DontTryTooHard</span>);<span class='comment'>

        // After processing a message, we consider doing some more work on the
        // event loop. The &quot;keep going&quot; condition changes after the first
        // iteration because we don&#39;t want to spin here infinitely.
        //
        // Once we start doing work we can keep doing work so long as the
        // iteration does something. Note that we don&#39;t want to starve the
        // message queue here, so each iteration when we&#39;re done working we
        // check the message queue regardless of whether we did work or not.
        </span><span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>keep_going</span> <span class='op'>=</span> <span class='op'>!</span><span class='ident'>did_work</span> <span class='op'>||</span> <span class='op'>!</span><span class='ident'>sched</span>.<span class='ident'>event_loop</span>.<span class='ident'>has_active_io</span>();
        <span class='kw'>while</span> <span class='ident'>keep_going</span> {
            <span class='kw'>let</span> (<span class='ident'>a</span>, <span class='ident'>b</span>, <span class='ident'>c</span>) <span class='op'>=</span> <span class='kw'>match</span> <span class='ident'>sched</span>.<span class='ident'>do_work</span>(<span class='ident'>stask</span>) {
                (<span class='ident'>sched</span>, <span class='ident'>task</span>, <span class='boolval'>false</span>) <span class='op'>=&gt;</span> {
                    <span class='ident'>sched</span>.<span class='ident'>interpret_message_queue</span>(<span class='ident'>task</span>, <span class='ident'>GiveItYourBest</span>)
                }
                (<span class='ident'>sched</span>, <span class='ident'>task</span>, <span class='boolval'>true</span>) <span class='op'>=&gt;</span> {
                    <span class='kw'>let</span> (<span class='ident'>sched</span>, <span class='ident'>task</span>, _) <span class='op'>=</span>
                        <span class='ident'>sched</span>.<span class='ident'>interpret_message_queue</span>(<span class='ident'>task</span>, <span class='ident'>GiveItYourBest</span>);
                    (<span class='ident'>sched</span>, <span class='ident'>task</span>, <span class='boolval'>true</span>)
                }
            };
            <span class='ident'>sched</span> <span class='op'>=</span> <span class='ident'>a</span>;
            <span class='ident'>stask</span> <span class='op'>=</span> <span class='ident'>b</span>;
            <span class='ident'>did_work</span> <span class='op'>=</span> <span class='ident'>c</span>;<span class='comment'>

            // We only keep going if we managed to do something productive and
            // also don&#39;t have any active I/O. If we didn&#39;t do anything, we
            // should consider going to sleep, and if we have active I/O we need
            // to poll for completion.
            </span><span class='ident'>keep_going</span> <span class='op'>=</span> <span class='ident'>did_work</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='ident'>sched</span>.<span class='ident'>event_loop</span>.<span class='ident'>has_active_io</span>();
        }<span class='comment'>

        // If we ever did some work, then we shouldn&#39;t put our scheduler
        // entirely to sleep just yet. Leave the idle callback active and fall
        // back to epoll() to see what&#39;s going on.
        </span><span class='kw'>if</span> <span class='ident'>did_work</span> {
            <span class='kw'>return</span> <span class='ident'>stask</span>.<span class='ident'>put_with_sched</span>(<span class='ident'>sched</span>);
        }<span class='comment'>

        // If we got here then there was no work to do.
        // Generate a SchedHandle and push it to the sleeper list so
        // somebody can wake us up later.
        </span><span class='kw'>if</span> <span class='op'>!</span><span class='ident'>sched</span>.<span class='ident'>sleepy</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='ident'>sched</span>.<span class='ident'>no_sleep</span> {
            <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;scheduler has no work to do, going to sleep&quot;</span>);
            <span class='ident'>sched</span>.<span class='ident'>sleepy</span> <span class='op'>=</span> <span class='boolval'>true</span>;
            <span class='kw'>let</span> <span class='ident'>handle</span> <span class='op'>=</span> <span class='ident'>sched</span>.<span class='ident'>make_handle</span>();
            <span class='ident'>sched</span>.<span class='ident'>sleeper_list</span>.<span class='ident'>push</span>(<span class='ident'>handle</span>);<span class='comment'>
            // Since we are sleeping, deactivate the idle callback.
            </span><span class='ident'>sched</span>.<span class='ident'>idle_callback</span>.<span class='ident'>get_mut_ref</span>().<span class='ident'>pause</span>();
        } <span class='kw'>else</span> {
            <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;not sleeping, already doing so or no_sleep set&quot;</span>);<span class='comment'>
            // We may not be sleeping, but we still need to deactivate
            // the idle callback.
            </span><span class='ident'>sched</span>.<span class='ident'>idle_callback</span>.<span class='ident'>get_mut_ref</span>().<span class='ident'>pause</span>();
        }<span class='comment'>

        // Finished a cycle without using the Scheduler. Place it back
        // in TLS.
        </span><span class='ident'>stask</span>.<span class='ident'>put_with_sched</span>(<span class='ident'>sched</span>);
    }<span class='comment'>

    // This function returns None if the scheduler is &quot;used&quot;, or it
    // returns the still-available scheduler. At this point all
    // message-handling will count as a turn of work, and as a result
    // return None.
    </span><span class='kw'>fn</span> <span class='ident'>interpret_message_queue</span>(<span class='kw-2'>mut</span> <span class='kw-2'>~</span><span class='self'>self</span>, <span class='ident'>stask</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>,
                               <span class='ident'>effort</span>: <span class='ident'>EffortLevel</span>)
            <span class='op'>-&gt;</span> (<span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>Scheduler</span><span class='op'>&gt;</span>, <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>, <span class='ident'>bool</span>)
    {

        <span class='kw'>let</span> <span class='ident'>msg</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='ident'>effort</span> <span class='op'>==</span> <span class='ident'>DontTryTooHard</span> {
            <span class='self'>self</span>.<span class='ident'>message_queue</span>.<span class='ident'>casual_pop</span>()
        } <span class='kw'>else</span> {<span class='comment'>
            // When popping our message queue, we could see an &quot;inconsistent&quot;
            // state which means that we *should* be able to pop data, but we
            // are unable to at this time. Our options are:
            //
            //  1. Spin waiting for data
            //  2. Ignore this and pretend we didn&#39;t find a message
            //
            // If we choose route 1, then if the pusher in question is currently
            // pre-empted, we&#39;re going to take up our entire time slice just
            // spinning on this queue. If we choose route 2, then the pusher in
            // question is still guaranteed to make a send() on its async
            // handle, so we will guaranteed wake up and see its message at some
            // point.
            //
            // I have chosen to take route #2.
            </span><span class='kw'>match</span> <span class='self'>self</span>.<span class='ident'>message_queue</span>.<span class='ident'>pop</span>() {
                <span class='ident'>msgq</span>::<span class='ident'>Data</span>(<span class='ident'>t</span>) <span class='op'>=&gt;</span> <span class='prelude-val'>Some</span>(<span class='ident'>t</span>),
                <span class='ident'>msgq</span>::<span class='ident'>Empty</span> <span class='op'>|</span> <span class='ident'>msgq</span>::<span class='ident'>Inconsistent</span> <span class='op'>=&gt;</span> <span class='prelude-val'>None</span>
            }
        };

        <span class='kw'>match</span> <span class='ident'>msg</span> {
            <span class='prelude-val'>Some</span>(<span class='ident'>PinnedTask</span>(<span class='ident'>task</span>)) <span class='op'>=&gt;</span> {
                <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>task</span> <span class='op'>=</span> <span class='ident'>task</span>;
                <span class='ident'>task</span>.<span class='ident'>give_home</span>(<span class='ident'>HomeSched</span>(<span class='self'>self</span>.<span class='ident'>make_handle</span>()));
                <span class='kw'>let</span> (<span class='ident'>sched</span>, <span class='ident'>task</span>) <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>resume_task_immediately</span>(<span class='ident'>stask</span>, <span class='ident'>task</span>);
                (<span class='ident'>sched</span>, <span class='ident'>task</span>, <span class='boolval'>true</span>)
            }
            <span class='prelude-val'>Some</span>(<span class='ident'>TaskFromFriend</span>(<span class='ident'>task</span>)) <span class='op'>=&gt;</span> {
                <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;got a task from a friend. lovely!&quot;</span>);
                <span class='kw'>let</span> (<span class='ident'>sched</span>, <span class='ident'>task</span>) <span class='op'>=</span>
                    <span class='self'>self</span>.<span class='ident'>process_task</span>(<span class='ident'>stask</span>, <span class='ident'>task</span>,
                                      <span class='ident'>Scheduler</span>::<span class='ident'>resume_task_immediately_cl</span>);
                (<span class='ident'>sched</span>, <span class='ident'>task</span>, <span class='boolval'>true</span>)
            }
            <span class='prelude-val'>Some</span>(<span class='ident'>RunOnce</span>(<span class='ident'>task</span>)) <span class='op'>=&gt;</span> {<span class='comment'>
                // bypass the process_task logic to force running this task once
                // on this home scheduler. This is often used for I/O (homing).
                </span><span class='kw'>let</span> (<span class='ident'>sched</span>, <span class='ident'>task</span>) <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>resume_task_immediately</span>(<span class='ident'>stask</span>, <span class='ident'>task</span>);
                (<span class='ident'>sched</span>, <span class='ident'>task</span>, <span class='boolval'>true</span>)
            }
            <span class='prelude-val'>Some</span>(<span class='ident'>Wake</span>) <span class='op'>=&gt;</span> {
                <span class='self'>self</span>.<span class='ident'>sleepy</span> <span class='op'>=</span> <span class='boolval'>false</span>;
                (<span class='self'>self</span>, <span class='ident'>stask</span>, <span class='boolval'>true</span>)
            }
            <span class='prelude-val'>Some</span>(<span class='ident'>Shutdown</span>) <span class='op'>=&gt;</span> {
                <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;shutting down&quot;</span>);
                <span class='kw'>if</span> <span class='self'>self</span>.<span class='ident'>sleepy</span> {<span class='comment'>
                    // There may be an outstanding handle on the
                    // sleeper list.  Pop them all to make sure that&#39;s
                    // not the case.
                    </span><span class='kw'>loop</span> {
                        <span class='kw'>match</span> <span class='self'>self</span>.<span class='ident'>sleeper_list</span>.<span class='ident'>pop</span>() {
                            <span class='prelude-val'>Some</span>(<span class='ident'>handle</span>) <span class='op'>=&gt;</span> {
                                <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>handle</span> <span class='op'>=</span> <span class='ident'>handle</span>;
                                <span class='ident'>handle</span>.<span class='ident'>send</span>(<span class='ident'>Wake</span>);
                            }
                            <span class='prelude-val'>None</span> <span class='op'>=&gt;</span> <span class='kw'>break</span>
                        }
                    }
                }<span class='comment'>
                // No more sleeping. After there are no outstanding
                // event loop references we will shut down.
                </span><span class='self'>self</span>.<span class='ident'>no_sleep</span> <span class='op'>=</span> <span class='boolval'>true</span>;
                <span class='self'>self</span>.<span class='ident'>sleepy</span> <span class='op'>=</span> <span class='boolval'>false</span>;
                (<span class='self'>self</span>, <span class='ident'>stask</span>, <span class='boolval'>true</span>)
            }
            <span class='prelude-val'>Some</span>(<span class='ident'>NewNeighbor</span>(<span class='ident'>neighbor</span>)) <span class='op'>=&gt;</span> {
                <span class='self'>self</span>.<span class='ident'>work_queues</span>.<span class='ident'>push</span>(<span class='ident'>neighbor</span>);
                (<span class='self'>self</span>, <span class='ident'>stask</span>, <span class='boolval'>false</span>)
            }
            <span class='prelude-val'>None</span> <span class='op'>=&gt;</span> (<span class='self'>self</span>, <span class='ident'>stask</span>, <span class='boolval'>false</span>)
        }
    }

    <span class='kw'>fn</span> <span class='ident'>do_work</span>(<span class='kw-2'>mut</span> <span class='kw-2'>~</span><span class='self'>self</span>, <span class='ident'>stask</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>)
               <span class='op'>-&gt;</span> (<span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>Scheduler</span><span class='op'>&gt;</span>, <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>, <span class='ident'>bool</span>) {
        <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;scheduler calling do work&quot;</span>);
        <span class='kw'>match</span> <span class='self'>self</span>.<span class='ident'>find_work</span>() {
            <span class='prelude-val'>Some</span>(<span class='ident'>task</span>) <span class='op'>=&gt;</span> {
                <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;found some work! running the task&quot;</span>);
                <span class='kw'>let</span> (<span class='ident'>sched</span>, <span class='ident'>task</span>) <span class='op'>=</span>
                    <span class='self'>self</span>.<span class='ident'>process_task</span>(<span class='ident'>stask</span>, <span class='ident'>task</span>,
                                      <span class='ident'>Scheduler</span>::<span class='ident'>resume_task_immediately_cl</span>);
                (<span class='ident'>sched</span>, <span class='ident'>task</span>, <span class='boolval'>true</span>)
            }
            <span class='prelude-val'>None</span> <span class='op'>=&gt;</span> {
                <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;no work was found, returning the scheduler struct&quot;</span>);
                (<span class='self'>self</span>, <span class='ident'>stask</span>, <span class='boolval'>false</span>)
            }
        }
    }<span class='comment'>

    // Workstealing: In this iteration of the runtime each scheduler
    // thread has a distinct work queue. When no work is available
    // locally, make a few attempts to steal work from the queues of
    // other scheduler threads. If a few steals fail we end up in the
    // old &quot;no work&quot; path which is fine.

    // First step in the process is to find a task. This function does
    // that by first checking the local queue, and if there is no work
    // there, trying to steal from the remote work queues.
    </span><span class='kw'>fn</span> <span class='ident'>find_work</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='prelude-ty'>Option</span><span class='op'>&lt;</span><span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;&gt;</span> {
        <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;scheduler looking for work&quot;</span>);
        <span class='kw'>if</span> <span class='op'>!</span><span class='self'>self</span>.<span class='ident'>steal_for_yield</span> {
            <span class='kw'>match</span> <span class='self'>self</span>.<span class='ident'>work_queue</span>.<span class='ident'>pop</span>() {
                <span class='prelude-val'>Some</span>(<span class='ident'>task</span>) <span class='op'>=&gt;</span> {
                    <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;found a task locally&quot;</span>);
                    <span class='kw'>return</span> <span class='prelude-val'>Some</span>(<span class='ident'>task</span>)
                }
                <span class='prelude-val'>None</span> <span class='op'>=&gt;</span> {
                    <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;scheduler trying to steal&quot;</span>);
                    <span class='kw'>return</span> <span class='self'>self</span>.<span class='ident'>try_steals</span>();
                }
            }
        } <span class='kw'>else</span> {<span class='comment'>
            // During execution of the last task, it performed a &#39;yield&#39;,
            // so we&#39;re doing some work stealing in order to introduce some
            // scheduling randomness. Otherwise we would just end up popping
            // that same task again. This is pretty lame and is to work around
            // the problem that work stealing is not designed for &#39;non-strict&#39;
            // (non-fork-join) task parallelism.
            </span><span class='self'>self</span>.<span class='ident'>steal_for_yield</span> <span class='op'>=</span> <span class='boolval'>false</span>;
            <span class='kw'>match</span> <span class='self'>self</span>.<span class='ident'>try_steals</span>() {
                <span class='prelude-val'>Some</span>(<span class='ident'>task</span>) <span class='op'>=&gt;</span> {
                    <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;stole a task after yielding&quot;</span>);
                    <span class='kw'>return</span> <span class='prelude-val'>Some</span>(<span class='ident'>task</span>);
                }
                <span class='prelude-val'>None</span> <span class='op'>=&gt;</span> {
                    <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;did not steal a task after yielding&quot;</span>);<span class='comment'>
                    // Back to business
                    </span><span class='kw'>return</span> <span class='self'>self</span>.<span class='ident'>find_work</span>();
                }
            }
        }
    }<span class='comment'>

    // Try stealing from all queues the scheduler knows about. This
    // naive implementation can steal from our own queue or from other
    // special schedulers.
    </span><span class='kw'>fn</span> <span class='ident'>try_steals</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='prelude-ty'>Option</span><span class='op'>&lt;</span><span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;&gt;</span> {
        <span class='kw'>let</span> <span class='ident'>work_queues</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>.<span class='ident'>work_queues</span>;
        <span class='kw'>let</span> <span class='ident'>len</span> <span class='op'>=</span> <span class='ident'>work_queues</span>.<span class='ident'>len</span>();
        <span class='kw'>let</span> <span class='ident'>start_index</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>rng</span>.<span class='ident'>gen_range</span>(<span class='number'>0</span>, <span class='ident'>len</span>);
        <span class='kw'>for</span> <span class='ident'>index</span> <span class='kw'>in</span> <span class='ident'>range</span>(<span class='number'>0</span>, <span class='ident'>len</span>).<span class='ident'>map</span>(<span class='op'>|</span><span class='ident'>i</span><span class='op'>|</span> (<span class='ident'>i</span> <span class='op'>+</span> <span class='ident'>start_index</span>) <span class='op'>%</span> <span class='ident'>len</span>) {
            <span class='kw'>match</span> <span class='ident'>work_queues</span>.<span class='ident'>get_mut</span>(<span class='ident'>index</span>).<span class='ident'>steal</span>() {
                <span class='ident'>deque</span>::<span class='ident'>Data</span>(<span class='ident'>task</span>) <span class='op'>=&gt;</span> {
                    <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;found task by stealing&quot;</span>);
                    <span class='kw'>return</span> <span class='prelude-val'>Some</span>(<span class='ident'>task</span>)
                }
                _ <span class='op'>=&gt;</span> ()
            }
        };
        <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;giving up on stealing&quot;</span>);
        <span class='kw'>return</span> <span class='prelude-val'>None</span>;
    }<span class='comment'>

    // * Task Routing Functions - Make sure tasks send up in the right
    // place.

    </span><span class='kw'>fn</span> <span class='ident'>process_task</span>(<span class='kw-2'>mut</span> <span class='kw-2'>~</span><span class='self'>self</span>,
                    <span class='ident'>cur</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>,
                    <span class='kw-2'>mut</span> <span class='ident'>next</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>,
                    <span class='ident'>schedule_fn</span>: <span class='ident'>SchedulingFn</span>)
                    <span class='op'>-&gt;</span> (<span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>Scheduler</span><span class='op'>&gt;</span>, <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>) {
        <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;processing a task&quot;</span>);

        <span class='kw'>match</span> <span class='ident'>next</span>.<span class='ident'>take_unwrap_home</span>() {
            <span class='ident'>HomeSched</span>(<span class='ident'>home_handle</span>) <span class='op'>=&gt;</span> {
                <span class='kw'>if</span> <span class='ident'>home_handle</span>.<span class='ident'>sched_id</span> <span class='op'>!=</span> <span class='self'>self</span>.<span class='ident'>sched_id</span>() {
                    <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;sending task home&quot;</span>);
                    <span class='ident'>next</span>.<span class='ident'>give_home</span>(<span class='ident'>HomeSched</span>(<span class='ident'>home_handle</span>));
                    <span class='ident'>Scheduler</span>::<span class='ident'>send_task_home</span>(<span class='ident'>next</span>);
                    (<span class='self'>self</span>, <span class='ident'>cur</span>)
                } <span class='kw'>else</span> {
                    <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;running task here&quot;</span>);
                    <span class='ident'>next</span>.<span class='ident'>give_home</span>(<span class='ident'>HomeSched</span>(<span class='ident'>home_handle</span>));
                    <span class='ident'>schedule_fn</span>(<span class='self'>self</span>, <span class='ident'>cur</span>, <span class='ident'>next</span>)
                }
            }
            <span class='ident'>AnySched</span> <span class='kw'>if</span> <span class='self'>self</span>.<span class='ident'>run_anything</span> <span class='op'>=&gt;</span> {
                <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;running anysched task here&quot;</span>);
                <span class='ident'>next</span>.<span class='ident'>give_home</span>(<span class='ident'>AnySched</span>);
                <span class='ident'>schedule_fn</span>(<span class='self'>self</span>, <span class='ident'>cur</span>, <span class='ident'>next</span>)
            }
            <span class='ident'>AnySched</span> <span class='op'>=&gt;</span> {
                <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;sending task to friend&quot;</span>);
                <span class='ident'>next</span>.<span class='ident'>give_home</span>(<span class='ident'>AnySched</span>);
                <span class='self'>self</span>.<span class='ident'>send_to_friend</span>(<span class='ident'>next</span>);
                (<span class='self'>self</span>, <span class='ident'>cur</span>)
            }
        }
    }

    <span class='kw'>fn</span> <span class='ident'>send_task_home</span>(<span class='ident'>task</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>) {
        <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>task</span> <span class='op'>=</span> <span class='ident'>task</span>;
        <span class='kw'>match</span> <span class='ident'>task</span>.<span class='ident'>take_unwrap_home</span>() {
            <span class='ident'>HomeSched</span>(<span class='kw-2'>mut</span> <span class='ident'>home_handle</span>) <span class='op'>=&gt;</span> <span class='ident'>home_handle</span>.<span class='ident'>send</span>(<span class='ident'>PinnedTask</span>(<span class='ident'>task</span>)),
            <span class='ident'>AnySched</span> <span class='op'>=&gt;</span> <span class='macro'>rtabort</span><span class='macro'>!</span>(<span class='string'>&quot;error: cannot send anysched task home&quot;</span>),
        }
    }

    <span class='doccomment'>/// Take a non-homed task we aren&#39;t allowed to run here and send</span>
    <span class='doccomment'>/// it to the designated friend scheduler to execute.</span>
    <span class='kw'>fn</span> <span class='ident'>send_to_friend</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>, <span class='ident'>task</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>) {
        <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;sending a task to friend&quot;</span>);
        <span class='kw'>match</span> <span class='self'>self</span>.<span class='ident'>friend_handle</span> {
            <span class='prelude-val'>Some</span>(<span class='kw-2'>ref</span> <span class='kw-2'>mut</span> <span class='ident'>handle</span>) <span class='op'>=&gt;</span> {
                <span class='ident'>handle</span>.<span class='ident'>send</span>(<span class='ident'>TaskFromFriend</span>(<span class='ident'>task</span>));
            }
            <span class='prelude-val'>None</span> <span class='op'>=&gt;</span> {
                <span class='macro'>rtabort</span><span class='macro'>!</span>(<span class='string'>&quot;tried to send task to a friend but scheduler has no friends&quot;</span>);
            }
        }
    }

    <span class='doccomment'>/// Schedule a task to be executed later.</span>
    <span class='doccomment'>///</span>
    <span class='doccomment'>/// Pushes the task onto the work stealing queue and tells the</span>
    <span class='doccomment'>/// event loop to run it later. Always use this instead of pushing</span>
    <span class='doccomment'>/// to the work queue directly.</span>
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>enqueue_task</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>, <span class='ident'>task</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>) {<span class='comment'>

        // We push the task onto our local queue clone.
        </span><span class='macro'>assert</span><span class='macro'>!</span>(<span class='op'>!</span><span class='ident'>task</span>.<span class='ident'>is_sched</span>());
        <span class='self'>self</span>.<span class='ident'>work_queue</span>.<span class='ident'>push</span>(<span class='ident'>task</span>);
        <span class='kw'>match</span> <span class='self'>self</span>.<span class='ident'>idle_callback</span> {
            <span class='prelude-val'>Some</span>(<span class='kw-2'>ref</span> <span class='kw-2'>mut</span> <span class='ident'>idle</span>) <span class='op'>=&gt;</span> <span class='ident'>idle</span>.<span class='ident'>resume</span>(),
            <span class='prelude-val'>None</span> <span class='op'>=&gt;</span> {}<span class='comment'> // allow enqueuing before the scheduler starts
        </span>}<span class='comment'>

        // We&#39;ve made work available. Notify a
        // sleeping scheduler.

        </span><span class='kw'>match</span> <span class='self'>self</span>.<span class='ident'>sleeper_list</span>.<span class='ident'>casual_pop</span>() {
            <span class='prelude-val'>Some</span>(<span class='ident'>handle</span>) <span class='op'>=&gt;</span> {
                <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>handle</span> <span class='op'>=</span> <span class='ident'>handle</span>;
                <span class='ident'>handle</span>.<span class='ident'>send</span>(<span class='ident'>Wake</span>)
            }
            <span class='prelude-val'>None</span> <span class='op'>=&gt;</span> { (<span class='comment'>/* pass */</span>) }
        };
    }<span class='comment'>

    // * Core Context Switching Functions

    // The primary function for changing contexts. In the current
    // design the scheduler is just a slightly modified GreenTask, so
    // all context swaps are from GreenTask to GreenTask. The only difference
    // between the various cases is where the inputs come from, and
    // what is done with the resulting task. That is specified by the
    // cleanup function f, which takes the scheduler and the
    // old task as inputs.

    </span><span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>change_task_context</span>(<span class='kw-2'>mut</span> <span class='kw-2'>~</span><span class='self'>self</span>,
                               <span class='kw-2'>mut</span> <span class='ident'>current_task</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>,
                               <span class='kw-2'>mut</span> <span class='ident'>next_task</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>,
                               <span class='ident'>f</span>: <span class='op'>|</span><span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>Scheduler</span>, <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span><span class='op'>|</span>)
                               <span class='op'>-&gt;</span> <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span> {
        <span class='kw'>let</span> <span class='ident'>f_opaque</span> <span class='op'>=</span> <span class='ident'>ClosureConverter</span>::<span class='ident'>from_fn</span>(<span class='ident'>f</span>);

        <span class='kw'>let</span> <span class='ident'>current_task_dupe</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='op'>*</span><span class='ident'>current_task</span> <span class='kw'>as</span> <span class='op'>*</span><span class='kw-2'>mut</span> <span class='ident'>GreenTask</span>;<span class='comment'>

        // The current task is placed inside an enum with the cleanup
        // function. This enum is then placed inside the scheduler.
        </span><span class='self'>self</span>.<span class='ident'>cleanup_job</span> <span class='op'>=</span> <span class='prelude-val'>Some</span>(<span class='ident'>CleanupJob</span>::<span class='ident'>new</span>(<span class='ident'>current_task</span>, <span class='ident'>f_opaque</span>));<span class='comment'>

        // The scheduler is then placed inside the next task.
        </span><span class='ident'>next_task</span>.<span class='ident'>sched</span> <span class='op'>=</span> <span class='prelude-val'>Some</span>(<span class='self'>self</span>);<span class='comment'>

        // However we still need an internal mutable pointer to the
        // original task. The strategy here was &quot;arrange memory, then
        // get pointers&quot;, so we crawl back up the chain using
        // transmute to eliminate borrowck errors.
        </span><span class='kw'>unsafe</span> {

            <span class='kw'>let</span> <span class='ident'>sched</span>: <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>Scheduler</span> <span class='op'>=</span>
                <span class='ident'>mem</span>::<span class='ident'>transmute</span>(<span class='kw-2'>&amp;</span><span class='op'>*</span><span class='op'>*</span><span class='ident'>next_task</span>.<span class='ident'>sched</span>.<span class='ident'>get_mut_ref</span>());

            <span class='kw'>let</span> <span class='ident'>current_task</span>: <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>GreenTask</span> <span class='op'>=</span> <span class='kw'>match</span> <span class='ident'>sched</span>.<span class='ident'>cleanup_job</span> {
                <span class='prelude-val'>Some</span>(<span class='ident'>CleanupJob</span> { <span class='ident'>task</span>: <span class='kw-2'>ref</span> <span class='kw-2'>mut</span> <span class='ident'>task</span>, .. }) <span class='op'>=&gt;</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='op'>*</span><span class='op'>*</span><span class='ident'>task</span>,
                <span class='prelude-val'>None</span> <span class='op'>=&gt;</span> <span class='macro'>rtabort</span><span class='macro'>!</span>(<span class='string'>&quot;no cleanup job&quot;</span>)
            };

            <span class='kw'>let</span> (<span class='ident'>current_task_context</span>, <span class='ident'>next_task_context</span>) <span class='op'>=</span>
                <span class='ident'>Scheduler</span>::<span class='ident'>get_contexts</span>(<span class='ident'>current_task</span>, <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='op'>*</span><span class='ident'>next_task</span>);<span class='comment'>

            // Done with everything - put the next task in TLS. This
            // works because due to transmute the borrow checker
            // believes that we have no internal pointers to
            // next_task.
            </span><span class='ident'>mem</span>::<span class='ident'>forget</span>(<span class='ident'>next_task</span>);<span class='comment'>

            // The raw context swap operation. The next action taken
            // will be running the cleanup job from the context of the
            // next task.
            </span><span class='ident'>Context</span>::<span class='ident'>swap</span>(<span class='ident'>current_task_context</span>, <span class='ident'>next_task_context</span>);
        }<span class='comment'>

        // When the context swaps back to this task we immediately
        // run the cleanup job, as expected by the previously called
        // swap_contexts function.
        </span><span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>current_task</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span> <span class='op'>=</span> <span class='kw'>unsafe</span> {
            <span class='ident'>mem</span>::<span class='ident'>transmute</span>(<span class='ident'>current_task_dupe</span>)
        };
        <span class='ident'>current_task</span>.<span class='ident'>sched</span>.<span class='ident'>get_mut_ref</span>().<span class='ident'>run_cleanup_job</span>();<span class='comment'>

        // See the comments in switch_running_tasks_and_then for why a lock
        // is acquired here. This is the resumption points and the &quot;bounce&quot;
        // that it is referring to.
        </span><span class='kw'>unsafe</span> {
            <span class='kw'>let</span> <span class='ident'>_guard</span> <span class='op'>=</span> <span class='ident'>current_task</span>.<span class='ident'>nasty_deschedule_lock</span>.<span class='ident'>lock</span>();
        }
        <span class='kw'>return</span> <span class='ident'>current_task</span>;
    }<span class='comment'>

    // Returns a mutable reference to both contexts involved in this
    // swap. This is unsafe - we are getting mutable internal
    // references to keep even when we don&#39;t own the tasks. It looks
    // kinda safe because we are doing transmutes before passing in
    // the arguments.
    </span><span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>get_contexts</span><span class='op'>&lt;</span><span class='lifetime'>&#39;a</span><span class='op'>&gt;</span>(<span class='ident'>current_task</span>: <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>GreenTask</span>,
                            <span class='ident'>next_task</span>: <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>GreenTask</span>)
        <span class='op'>-&gt;</span> (<span class='kw-2'>&amp;</span><span class='lifetime'>&#39;a</span> <span class='kw-2'>mut</span> <span class='ident'>Context</span>, <span class='kw-2'>&amp;</span><span class='lifetime'>&#39;a</span> <span class='kw-2'>mut</span> <span class='ident'>Context</span>)
    {
        <span class='kw'>let</span> <span class='ident'>current_task_context</span> <span class='op'>=</span>
            <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>current_task</span>.<span class='ident'>coroutine</span>.<span class='ident'>get_mut_ref</span>().<span class='ident'>saved_context</span>;
        <span class='kw'>let</span> <span class='ident'>next_task_context</span> <span class='op'>=</span>
                <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>next_task</span>.<span class='ident'>coroutine</span>.<span class='ident'>get_mut_ref</span>().<span class='ident'>saved_context</span>;
        <span class='kw'>unsafe</span> {
            (<span class='ident'>mem</span>::<span class='ident'>transmute</span>(<span class='ident'>current_task_context</span>),
             <span class='ident'>mem</span>::<span class='ident'>transmute</span>(<span class='ident'>next_task_context</span>))
        }
    }<span class='comment'>

    // * Context Swapping Helpers - Here be ugliness!

    </span><span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>resume_task_immediately</span>(<span class='kw-2'>~</span><span class='self'>self</span>,
                                   <span class='ident'>cur</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>,
                                   <span class='ident'>next</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>)
                                   <span class='op'>-&gt;</span> (<span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>Scheduler</span><span class='op'>&gt;</span>, <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>) {
        <span class='macro'>assert</span><span class='macro'>!</span>(<span class='ident'>cur</span>.<span class='ident'>is_sched</span>());
        <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>cur</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>change_task_context</span>(<span class='ident'>cur</span>, <span class='ident'>next</span>, <span class='op'>|</span><span class='ident'>sched</span>, <span class='ident'>stask</span><span class='op'>|</span> {
            <span class='macro'>assert</span><span class='macro'>!</span>(<span class='ident'>sched</span>.<span class='ident'>sched_task</span>.<span class='ident'>is_none</span>());
            <span class='ident'>sched</span>.<span class='ident'>sched_task</span> <span class='op'>=</span> <span class='prelude-val'>Some</span>(<span class='ident'>stask</span>);
        });
        (<span class='ident'>cur</span>.<span class='ident'>sched</span>.<span class='ident'>take_unwrap</span>(), <span class='ident'>cur</span>)
    }

    <span class='kw'>fn</span> <span class='ident'>resume_task_immediately_cl</span>(<span class='ident'>sched</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>Scheduler</span><span class='op'>&gt;</span>,
                                  <span class='ident'>cur</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>,
                                  <span class='ident'>next</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>)
                                  <span class='op'>-&gt;</span> (<span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>Scheduler</span><span class='op'>&gt;</span>, <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>) {
        <span class='ident'>sched</span>.<span class='ident'>resume_task_immediately</span>(<span class='ident'>cur</span>, <span class='ident'>next</span>)
    }

    <span class='doccomment'>/// Block a running task, context switch to the scheduler, then pass the</span>
    <span class='doccomment'>/// blocked task to a closure.</span>
    <span class='doccomment'>///</span>
    <span class='doccomment'>/// # Safety note</span>
    <span class='doccomment'>///</span>
    <span class='doccomment'>/// The closure here is a *stack* closure that lives in the</span>
    <span class='doccomment'>/// running task.  It gets transmuted to the scheduler&#39;s lifetime</span>
    <span class='doccomment'>/// and called while the task is blocked.</span>
    <span class='doccomment'>///</span>
    <span class='doccomment'>/// This passes a Scheduler pointer to the fn after the context switch</span>
    <span class='doccomment'>/// in order to prevent that fn from performing further scheduling operations.</span>
    <span class='doccomment'>/// Doing further scheduling could easily result in infinite recursion.</span>
    <span class='doccomment'>///</span>
    <span class='doccomment'>/// Note that if the closure provided relinquishes ownership of the</span>
    <span class='doccomment'>/// BlockedTask, then it is possible for the task to resume execution before</span>
    <span class='doccomment'>/// the closure has finished executing. This would naturally introduce a</span>
    <span class='doccomment'>/// race if the closure and task shared portions of the environment.</span>
    <span class='doccomment'>///</span>
    <span class='doccomment'>/// This situation is currently prevented, or in other words it is</span>
    <span class='doccomment'>/// guaranteed that this function will not return before the given closure</span>
    <span class='doccomment'>/// has returned.</span>
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>deschedule_running_task_and_then</span>(<span class='kw-2'>mut</span> <span class='kw-2'>~</span><span class='self'>self</span>,
                                            <span class='ident'>cur</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>,
                                            <span class='ident'>f</span>: <span class='op'>|</span><span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>Scheduler</span>, <span class='ident'>BlockedTask</span><span class='op'>|</span>) {<span class='comment'>
        // Trickier - we need to get the scheduler task out of self
        // and use it as the destination.
        </span><span class='kw'>let</span> <span class='ident'>stask</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>sched_task</span>.<span class='ident'>take_unwrap</span>();<span class='comment'>
        // Otherwise this is the same as below.
        </span><span class='self'>self</span>.<span class='ident'>switch_running_tasks_and_then</span>(<span class='ident'>cur</span>, <span class='ident'>stask</span>, <span class='ident'>f</span>)
    }

    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>switch_running_tasks_and_then</span>(<span class='kw-2'>~</span><span class='self'>self</span>,
                                         <span class='ident'>cur</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>,
                                         <span class='ident'>next</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>,
                                         <span class='ident'>f</span>: <span class='op'>|</span><span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>Scheduler</span>, <span class='ident'>BlockedTask</span><span class='op'>|</span>) {<span class='comment'>
        // And here comes one of the sad moments in which a lock is used in a
        // core portion of the rust runtime. As always, this is highly
        // undesirable, so there&#39;s a good reason behind it.
        //
        // There is an excellent outline of the problem in issue #8132, and it&#39;s
        // summarized in that `f` is executed on a sched task, but its
        // environment is on the previous task. If `f` relinquishes ownership of
        // the BlockedTask, then it may introduce a race where `f` is using the
        // environment as well as the code after the &#39;deschedule&#39; block.
        //
        // The solution we have chosen to adopt for now is to acquire a
        // task-local lock around this block. The resumption of the task in
        // context switching will bounce on the lock, thereby waiting for this
        // block to finish, eliminating the race mentioned above.
        // fail!(&quot;should never return!&quot;);
        //
        // To actually maintain a handle to the lock, we use an unsafe pointer
        // to it, but we&#39;re guaranteed that the task won&#39;t exit until we&#39;ve
        // unlocked the lock so there&#39;s no worry of this memory going away.
        </span><span class='kw'>let</span> <span class='ident'>cur</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>change_task_context</span>(<span class='ident'>cur</span>, <span class='ident'>next</span>, <span class='op'>|</span><span class='ident'>sched</span>, <span class='kw-2'>mut</span> <span class='ident'>task</span><span class='op'>|</span> {
            <span class='kw'>let</span> <span class='ident'>lock</span>: <span class='op'>*</span><span class='kw-2'>mut</span> <span class='ident'>NativeMutex</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>task</span>.<span class='ident'>nasty_deschedule_lock</span>;
            <span class='kw'>unsafe</span> {
                <span class='kw'>let</span> <span class='ident'>_guard</span> <span class='op'>=</span> (<span class='op'>*</span><span class='ident'>lock</span>).<span class='ident'>lock</span>();
                <span class='ident'>f</span>(<span class='ident'>sched</span>, <span class='ident'>BlockedTask</span>::<span class='ident'>block</span>(<span class='ident'>task</span>.<span class='ident'>swap</span>()));
            }
        });
        <span class='ident'>cur</span>.<span class='ident'>put</span>();
    }

    <span class='kw'>fn</span> <span class='ident'>switch_task</span>(<span class='ident'>sched</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>Scheduler</span><span class='op'>&gt;</span>,
                   <span class='ident'>cur</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>,
                   <span class='ident'>next</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>)
                   <span class='op'>-&gt;</span> (<span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>Scheduler</span><span class='op'>&gt;</span>, <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>) {
        <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>cur</span> <span class='op'>=</span> <span class='ident'>sched</span>.<span class='ident'>change_task_context</span>(<span class='ident'>cur</span>, <span class='ident'>next</span>, <span class='op'>|</span><span class='ident'>sched</span>, <span class='ident'>last_task</span><span class='op'>|</span> {
            <span class='kw'>if</span> <span class='ident'>last_task</span>.<span class='ident'>is_sched</span>() {
                <span class='macro'>assert</span><span class='macro'>!</span>(<span class='ident'>sched</span>.<span class='ident'>sched_task</span>.<span class='ident'>is_none</span>());
                <span class='ident'>sched</span>.<span class='ident'>sched_task</span> <span class='op'>=</span> <span class='prelude-val'>Some</span>(<span class='ident'>last_task</span>);
            } <span class='kw'>else</span> {
                <span class='ident'>sched</span>.<span class='ident'>enqueue_task</span>(<span class='ident'>last_task</span>);
            }
        });
        (<span class='ident'>cur</span>.<span class='ident'>sched</span>.<span class='ident'>take_unwrap</span>(), <span class='ident'>cur</span>)
    }<span class='comment'>

    // * Task Context Helpers

    </span><span class='doccomment'>/// Called by a running task to end execution, after which it will</span>
    <span class='doccomment'>/// be recycled by the scheduler for reuse in a new task.</span>
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>terminate_current_task</span>(<span class='kw-2'>mut</span> <span class='kw-2'>~</span><span class='self'>self</span>, <span class='ident'>cur</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>) <span class='op'>-&gt;</span> <span class='op'>!</span> {<span class='comment'>
        // Similar to deschedule running task and then, but cannot go through
        // the task-blocking path. The task is already dying.
        </span><span class='kw'>let</span> <span class='ident'>stask</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>sched_task</span>.<span class='ident'>take_unwrap</span>();
        <span class='kw'>let</span> <span class='ident'>_cur</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>change_task_context</span>(<span class='ident'>cur</span>, <span class='ident'>stask</span>, <span class='op'>|</span><span class='ident'>sched</span>, <span class='kw-2'>mut</span> <span class='ident'>dead_task</span><span class='op'>|</span> {
            <span class='kw'>let</span> <span class='ident'>coroutine</span> <span class='op'>=</span> <span class='ident'>dead_task</span>.<span class='ident'>coroutine</span>.<span class='ident'>take_unwrap</span>();
            <span class='ident'>coroutine</span>.<span class='ident'>recycle</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>sched</span>.<span class='ident'>stack_pool</span>);
            <span class='ident'>sched</span>.<span class='ident'>task_state</span>.<span class='ident'>decrement</span>();
        });
        <span class='macro'>fail</span><span class='macro'>!</span>(<span class='string'>&quot;should never return!&quot;</span>);
    }

    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>run_task</span>(<span class='kw-2'>~</span><span class='self'>self</span>, <span class='ident'>cur</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>, <span class='ident'>next</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>) {
        <span class='kw'>let</span> (<span class='ident'>sched</span>, <span class='ident'>task</span>) <span class='op'>=</span>
            <span class='self'>self</span>.<span class='ident'>process_task</span>(<span class='ident'>cur</span>, <span class='ident'>next</span>, <span class='ident'>Scheduler</span>::<span class='ident'>switch_task</span>);
        <span class='ident'>task</span>.<span class='ident'>put_with_sched</span>(<span class='ident'>sched</span>);
    }

    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>run_task_later</span>(<span class='kw-2'>mut</span> <span class='ident'>cur</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>, <span class='ident'>next</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>) {
        <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>sched</span> <span class='op'>=</span> <span class='ident'>cur</span>.<span class='ident'>sched</span>.<span class='ident'>take_unwrap</span>();
        <span class='ident'>sched</span>.<span class='ident'>enqueue_task</span>(<span class='ident'>next</span>);
        <span class='ident'>cur</span>.<span class='ident'>put_with_sched</span>(<span class='ident'>sched</span>);
    }

    <span class='doccomment'>/// Yield control to the scheduler, executing another task. This is guaranteed</span>
    <span class='doccomment'>/// to introduce some amount of randomness to the scheduler. Currently the</span>
    <span class='doccomment'>/// randomness is a result of performing a round of work stealing (which</span>
    <span class='doccomment'>/// may end up stealing from the current scheduler).</span>
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>yield_now</span>(<span class='kw-2'>mut</span> <span class='kw-2'>~</span><span class='self'>self</span>, <span class='ident'>cur</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>) {<span class='comment'>
        // Async handles trigger the scheduler by calling yield_now on the local
        // task, which eventually gets us to here. See comments in SchedRunner
        // for more info on this.
        </span><span class='kw'>if</span> <span class='ident'>cur</span>.<span class='ident'>is_sched</span>() {
            <span class='macro'>assert</span><span class='macro'>!</span>(<span class='self'>self</span>.<span class='ident'>sched_task</span>.<span class='ident'>is_none</span>());
            <span class='self'>self</span>.<span class='ident'>run_sched_once</span>(<span class='ident'>cur</span>);
        } <span class='kw'>else</span> {
            <span class='self'>self</span>.<span class='ident'>yield_check_count</span> <span class='op'>=</span> <span class='ident'>reset_yield_check</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>.<span class='ident'>rng</span>);<span class='comment'>
            // Tell the scheduler to start stealing on the next iteration
            </span><span class='self'>self</span>.<span class='ident'>steal_for_yield</span> <span class='op'>=</span> <span class='boolval'>true</span>;
            <span class='kw'>let</span> <span class='ident'>stask</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>sched_task</span>.<span class='ident'>take_unwrap</span>();
            <span class='kw'>let</span> <span class='ident'>cur</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>change_task_context</span>(<span class='ident'>cur</span>, <span class='ident'>stask</span>, <span class='op'>|</span><span class='ident'>sched</span>, <span class='ident'>task</span><span class='op'>|</span> {
                <span class='ident'>sched</span>.<span class='ident'>enqueue_task</span>(<span class='ident'>task</span>);
            });
            <span class='ident'>cur</span>.<span class='ident'>put</span>()
        }
    }

    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>maybe_yield</span>(<span class='kw-2'>mut</span> <span class='kw-2'>~</span><span class='self'>self</span>, <span class='ident'>cur</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>) {<span class='comment'>
        // It&#39;s possible for sched tasks to possibly call this function, and it
        // just means that they&#39;re likely sending on channels (which
        // occasionally call this function). Sched tasks follow different paths
        // when executing yield_now(), which may possibly trip the assertion
        // below. For this reason, we just have sched tasks bail out soon.
        //
        // Sched tasks have no need to yield anyway because as soon as they
        // return they&#39;ll yield to other threads by falling back to the event
        // loop. Additionally, we completely control sched tasks, so we can make
        // sure that they never execute more than enough code.
        </span><span class='kw'>if</span> <span class='ident'>cur</span>.<span class='ident'>is_sched</span>() {
            <span class='kw'>return</span> <span class='ident'>cur</span>.<span class='ident'>put_with_sched</span>(<span class='self'>self</span>)
        }<span class='comment'>

        // The number of times to do the yield check before yielding, chosen
        // arbitrarily.
        </span><span class='macro'>rtassert</span><span class='macro'>!</span>(<span class='self'>self</span>.<span class='ident'>yield_check_count</span> <span class='op'>&gt;</span> <span class='number'>0</span>);
        <span class='self'>self</span>.<span class='ident'>yield_check_count</span> <span class='op'>-=</span> <span class='number'>1</span>;
        <span class='kw'>if</span> <span class='self'>self</span>.<span class='ident'>yield_check_count</span> <span class='op'>==</span> <span class='number'>0</span> {
            <span class='self'>self</span>.<span class='ident'>yield_now</span>(<span class='ident'>cur</span>);
        } <span class='kw'>else</span> {
            <span class='ident'>cur</span>.<span class='ident'>put_with_sched</span>(<span class='self'>self</span>);
        }
    }<span class='comment'>


    // * Utility Functions

    </span><span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>sched_id</span>(<span class='kw-2'>&amp;</span><span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='ident'>uint</span> { <span class='self'>self</span> <span class='kw'>as</span> <span class='op'>*</span><span class='kw'>const</span> <span class='ident'>Scheduler</span> <span class='kw'>as</span> <span class='ident'>uint</span> }

    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>run_cleanup_job</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>) {
        <span class='kw'>let</span> <span class='ident'>cleanup_job</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>cleanup_job</span>.<span class='ident'>take_unwrap</span>();
        <span class='ident'>cleanup_job</span>.<span class='ident'>run</span>(<span class='self'>self</span>)
    }

    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>make_handle</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='ident'>SchedHandle</span> {
        <span class='kw'>let</span> <span class='ident'>remote</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>event_loop</span>.<span class='ident'>remote_callback</span>(<span class='kw'>box</span> <span class='ident'>SchedRunner</span>);

        <span class='kw'>return</span> <span class='ident'>SchedHandle</span> {
            <span class='ident'>remote</span>: <span class='ident'>remote</span>,
            <span class='ident'>queue</span>: <span class='self'>self</span>.<span class='ident'>message_producer</span>.<span class='ident'>clone</span>(),
            <span class='ident'>sched_id</span>: <span class='self'>self</span>.<span class='ident'>sched_id</span>()
        }
    }
}<span class='comment'>

// Supporting types

</span><span class='kw'>type</span> <span class='ident'>SchedulingFn</span> <span class='op'>=</span> <span class='kw'>fn</span>(<span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>Scheduler</span><span class='op'>&gt;</span>, <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>, <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>)
                       <span class='op'>-&gt;</span> (<span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>Scheduler</span><span class='op'>&gt;</span>, <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>);

<span class='kw'>pub</span> <span class='kw'>enum</span> <span class='ident'>SchedMessage</span> {
    <span class='ident'>Wake</span>,
    <span class='ident'>Shutdown</span>,
    <span class='ident'>NewNeighbor</span>(<span class='ident'>deque</span>::<span class='ident'>Stealer</span><span class='op'>&lt;</span><span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;&gt;</span>),
    <span class='ident'>PinnedTask</span>(<span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>),
    <span class='ident'>TaskFromFriend</span>(<span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>),
    <span class='ident'>RunOnce</span>(<span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>),
}

<span class='kw'>pub</span> <span class='kw'>struct</span> <span class='ident'>SchedHandle</span> {
    <span class='ident'>remote</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>RemoteCallback</span> <span class='op'>+</span> <span class='ident'>Send</span><span class='op'>&gt;</span>,
    <span class='ident'>queue</span>: <span class='ident'>msgq</span>::<span class='ident'>Producer</span><span class='op'>&lt;</span><span class='ident'>SchedMessage</span><span class='op'>&gt;</span>,
    <span class='kw'>pub</span> <span class='ident'>sched_id</span>: <span class='ident'>uint</span>
}

<span class='kw'>impl</span> <span class='ident'>SchedHandle</span> {
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>send</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>, <span class='ident'>msg</span>: <span class='ident'>SchedMessage</span>) {
        <span class='self'>self</span>.<span class='ident'>queue</span>.<span class='ident'>push</span>(<span class='ident'>msg</span>);
        <span class='self'>self</span>.<span class='ident'>remote</span>.<span class='ident'>fire</span>();
    }
}

<span class='kw'>struct</span> <span class='ident'>SchedRunner</span>;

<span class='kw'>impl</span> <span class='ident'>Callback</span> <span class='kw'>for</span> <span class='ident'>SchedRunner</span> {
    <span class='kw'>fn</span> <span class='ident'>call</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>) {<span class='comment'>
        // In theory, this function needs to invoke the `run_sched_once`
        // function on the scheduler. Sadly, we have no context here, except for
        // knowledge of the local `Task`. In order to avoid a call to
        // `GreenTask::convert`, we just call `yield_now` and the scheduler will
        // detect when a sched task performs a yield vs a green task performing
        // a yield (and act accordingly).
        //
        // This function could be converted to `GreenTask::convert` if
        // absolutely necessary, but for cleanliness it is much better to not
        // use the conversion function.
        </span><span class='kw'>let</span> <span class='ident'>task</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>Task</span><span class='op'>&gt;</span> <span class='op'>=</span> <span class='ident'>Local</span>::<span class='ident'>take</span>();
        <span class='ident'>task</span>.<span class='ident'>yield_now</span>();
    }
}

<span class='kw'>struct</span> <span class='ident'>CleanupJob</span> {
    <span class='ident'>task</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>,
    <span class='ident'>f</span>: <span class='ident'>UnsafeTaskReceiver</span>
}

<span class='kw'>impl</span> <span class='ident'>CleanupJob</span> {
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>new</span>(<span class='ident'>task</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>, <span class='ident'>f</span>: <span class='ident'>UnsafeTaskReceiver</span>) <span class='op'>-&gt;</span> <span class='ident'>CleanupJob</span> {
        <span class='ident'>CleanupJob</span> {
            <span class='ident'>task</span>: <span class='ident'>task</span>,
            <span class='ident'>f</span>: <span class='ident'>f</span>
        }
    }

    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>run</span>(<span class='self'>self</span>, <span class='ident'>sched</span>: <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>Scheduler</span>) {
        <span class='kw'>let</span> <span class='ident'>CleanupJob</span> { <span class='ident'>task</span>: <span class='ident'>task</span>, <span class='ident'>f</span>: <span class='ident'>f</span> } <span class='op'>=</span> <span class='self'>self</span>;
        <span class='ident'>f</span>.<span class='ident'>to_fn</span>()(<span class='ident'>sched</span>, <span class='ident'>task</span>)
    }
}<span class='comment'>

// FIXME: Some hacks to put a || closure in Scheduler without borrowck
// complaining
</span><span class='kw'>type</span> <span class='ident'>UnsafeTaskReceiver</span> <span class='op'>=</span> <span class='ident'>raw</span>::<span class='ident'>Closure</span>;
<span class='kw'>trait</span> <span class='ident'>ClosureConverter</span> {
    <span class='kw'>fn</span> <span class='ident'>from_fn</span>(<span class='op'>|</span><span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>Scheduler</span>, <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span><span class='op'>|</span>) <span class='op'>-&gt;</span> <span class='ident'>Self</span>;
    <span class='kw'>fn</span> <span class='ident'>to_fn</span>(<span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='op'>|</span><span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>Scheduler</span>, <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span><span class='op'>|</span>;
}
<span class='kw'>impl</span> <span class='ident'>ClosureConverter</span> <span class='kw'>for</span> <span class='ident'>UnsafeTaskReceiver</span> {
    <span class='kw'>fn</span> <span class='ident'>from_fn</span>(<span class='ident'>f</span>: <span class='op'>|</span><span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>Scheduler</span>, <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span><span class='op'>|</span>) <span class='op'>-&gt;</span> <span class='ident'>UnsafeTaskReceiver</span> {
        <span class='kw'>unsafe</span> { <span class='ident'>mem</span>::<span class='ident'>transmute</span>(<span class='ident'>f</span>) }
    }
    <span class='kw'>fn</span> <span class='ident'>to_fn</span>(<span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='op'>|</span><span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>Scheduler</span>, <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span><span class='op'>|</span> {
        <span class='kw'>unsafe</span> { <span class='ident'>mem</span>::<span class='ident'>transmute</span>(<span class='self'>self</span>) }
    }
}<span class='comment'>

// On unix, we read randomness straight from /dev/urandom, but the
// default constructor of an XorShiftRng does this via io::fs, which
// relies on the scheduler existing, so we have to manually load
// randomness. Windows has its own C API for this, so we don&#39;t need to
// worry there.
</span><span class='attribute'>#[<span class='ident'>cfg</span>(<span class='ident'>windows</span>)]</span>
<span class='kw'>fn</span> <span class='ident'>new_sched_rng</span>() <span class='op'>-&gt;</span> <span class='ident'>XorShiftRng</span> {
    <span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>rand</span>::<span class='ident'>OsRng</span>;
    <span class='kw'>match</span> <span class='ident'>OsRng</span>::<span class='ident'>new</span>() {
        <span class='prelude-val'>Ok</span>(<span class='kw-2'>mut</span> <span class='ident'>r</span>) <span class='op'>=&gt;</span> <span class='ident'>r</span>.<span class='ident'>gen</span>(),
        <span class='prelude-val'>Err</span>(<span class='ident'>e</span>) <span class='op'>=&gt;</span> {
            <span class='macro'>rtabort</span><span class='macro'>!</span>(<span class='string'>&quot;sched: failed to create seeded RNG: {}&quot;</span>, <span class='ident'>e</span>)
        }
    }
}
<span class='attribute'>#[<span class='ident'>cfg</span>(<span class='ident'>unix</span>)]</span>
<span class='kw'>fn</span> <span class='ident'>new_sched_rng</span>() <span class='op'>-&gt;</span> <span class='ident'>XorShiftRng</span> {
    <span class='kw'>use</span> <span class='ident'>libc</span>;
    <span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>mem</span>;
    <span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>rand</span>::<span class='ident'>SeedableRng</span>;

    <span class='kw'>let</span> <span class='ident'>fd</span> <span class='op'>=</span> <span class='string'>&quot;/dev/urandom&quot;</span>.<span class='ident'>with_c_str</span>(<span class='op'>|</span><span class='ident'>name</span><span class='op'>|</span> {
        <span class='kw'>unsafe</span> { <span class='ident'>libc</span>::<span class='ident'>open</span>(<span class='ident'>name</span>, <span class='ident'>libc</span>::<span class='ident'>O_RDONLY</span>, <span class='number'>0</span>) }
    });
    <span class='kw'>if</span> <span class='ident'>fd</span> <span class='op'>==</span> <span class='op'>-</span><span class='number'>1</span> {
        <span class='macro'>rtabort</span><span class='macro'>!</span>(<span class='string'>&quot;could not open /dev/urandom for reading.&quot;</span>)
    }

    <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>seeds</span> <span class='op'>=</span> [<span class='number'>0u32</span>, .. <span class='number'>4</span>];
    <span class='kw'>let</span> <span class='ident'>size</span> <span class='op'>=</span> <span class='ident'>mem</span>::<span class='ident'>size_of_val</span>(<span class='kw-2'>&amp;</span><span class='ident'>seeds</span>);
    <span class='kw'>loop</span> {
        <span class='kw'>let</span> <span class='ident'>nbytes</span> <span class='op'>=</span> <span class='kw'>unsafe</span> {
            <span class='ident'>libc</span>::<span class='ident'>read</span>(<span class='ident'>fd</span>,
                       <span class='ident'>seeds</span>.<span class='ident'>as_mut_ptr</span>() <span class='kw'>as</span> <span class='op'>*</span><span class='kw-2'>mut</span> <span class='ident'>libc</span>::<span class='ident'>c_void</span>,
                       <span class='ident'>size</span> <span class='kw'>as</span> <span class='ident'>libc</span>::<span class='ident'>size_t</span>)
        };
        <span class='macro'>rtassert</span><span class='macro'>!</span>(<span class='ident'>nbytes</span> <span class='kw'>as</span> <span class='ident'>uint</span> <span class='op'>==</span> <span class='ident'>size</span>);

        <span class='kw'>if</span> <span class='op'>!</span><span class='ident'>seeds</span>.<span class='ident'>iter</span>().<span class='ident'>all</span>(<span class='op'>|</span><span class='ident'>x</span><span class='op'>|</span> <span class='op'>*</span><span class='ident'>x</span> <span class='op'>==</span> <span class='number'>0</span>) {
            <span class='kw'>break</span>;
        }
    }

    <span class='kw'>unsafe</span> {<span class='ident'>libc</span>::<span class='ident'>close</span>(<span class='ident'>fd</span>);}

    <span class='ident'>SeedableRng</span>::<span class='ident'>from_seed</span>(<span class='ident'>seeds</span>)
}

<span class='attribute'>#[<span class='ident'>cfg</span>(<span class='ident'>test</span>)]</span>
<span class='kw'>mod</span> <span class='ident'>test</span> {
    <span class='kw'>use</span> <span class='ident'>rustuv</span>;

    <span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>rt</span>::<span class='ident'>task</span>::<span class='ident'>TaskOpts</span>;
    <span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>rt</span>::<span class='ident'>task</span>::<span class='ident'>Task</span>;
    <span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>rt</span>::<span class='ident'>local</span>::<span class='ident'>Local</span>;

    <span class='kw'>use</span> {<span class='ident'>TaskState</span>, <span class='ident'>PoolConfig</span>, <span class='ident'>SchedPool</span>};
    <span class='kw'>use</span> <span class='ident'>basic</span>;
    <span class='kw'>use</span> <span class='ident'>sched</span>::{<span class='ident'>TaskFromFriend</span>, <span class='ident'>PinnedTask</span>};
    <span class='kw'>use</span> <span class='ident'>task</span>::{<span class='ident'>GreenTask</span>, <span class='ident'>HomeSched</span>, <span class='ident'>AnySched</span>};

    <span class='kw'>fn</span> <span class='ident'>pool</span>() <span class='op'>-&gt;</span> <span class='ident'>SchedPool</span> {
        <span class='ident'>SchedPool</span>::<span class='ident'>new</span>(<span class='ident'>PoolConfig</span> {
            <span class='ident'>threads</span>: <span class='number'>1</span>,
            <span class='ident'>event_loop_factory</span>: <span class='ident'>basic</span>::<span class='ident'>event_loop</span>,
        })
    }

    <span class='kw'>fn</span> <span class='ident'>run</span>(<span class='ident'>f</span>: <span class='kw'>proc</span>():<span class='ident'>Send</span>) {
        <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>pool</span> <span class='op'>=</span> <span class='ident'>pool</span>();
        <span class='ident'>pool</span>.<span class='ident'>spawn</span>(<span class='ident'>TaskOpts</span>::<span class='ident'>new</span>(), <span class='ident'>f</span>);
        <span class='ident'>pool</span>.<span class='ident'>shutdown</span>();
    }

    <span class='kw'>fn</span> <span class='ident'>sched_id</span>() <span class='op'>-&gt;</span> <span class='ident'>uint</span> {
        <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>task</span> <span class='op'>=</span> <span class='ident'>Local</span>::<span class='ident'>borrow</span>(<span class='prelude-val'>None</span>::<span class='op'>&lt;</span><span class='ident'>Task</span><span class='op'>&gt;</span>);
        <span class='kw'>match</span> <span class='ident'>task</span>.<span class='ident'>maybe_take_runtime</span>::<span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>() {
            <span class='prelude-val'>Some</span>(<span class='ident'>green</span>) <span class='op'>=&gt;</span> {
                <span class='kw'>let</span> <span class='ident'>ret</span> <span class='op'>=</span> <span class='ident'>green</span>.<span class='ident'>sched</span>.<span class='ident'>get_ref</span>().<span class='ident'>sched_id</span>();
                <span class='ident'>task</span>.<span class='ident'>put_runtime</span>(<span class='ident'>green</span>);
                <span class='kw'>return</span> <span class='ident'>ret</span>;
            }
            <span class='prelude-val'>None</span> <span class='op'>=&gt;</span> <span class='macro'>fail</span><span class='macro'>!</span>()
        }
    }

    <span class='attribute'>#[<span class='ident'>test</span>]</span>
    <span class='kw'>fn</span> <span class='ident'>trivial_run_in_newsched_task_test</span>() {
        <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>task_ran</span> <span class='op'>=</span> <span class='boolval'>false</span>;
        <span class='kw'>let</span> <span class='ident'>task_ran_ptr</span>: <span class='op'>*</span><span class='kw-2'>mut</span> <span class='ident'>bool</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>task_ran</span>;
        <span class='ident'>run</span>(<span class='kw'>proc</span>() {
            <span class='kw'>unsafe</span> { <span class='op'>*</span><span class='ident'>task_ran_ptr</span> <span class='op'>=</span> <span class='boolval'>true</span> };
            <span class='macro'>rtdebug</span><span class='macro'>!</span>(<span class='string'>&quot;executed from the new scheduler&quot;</span>)
        });
        <span class='macro'>assert</span><span class='macro'>!</span>(<span class='ident'>task_ran</span>);
    }

    <span class='attribute'>#[<span class='ident'>test</span>]</span>
    <span class='kw'>fn</span> <span class='ident'>multiple_task_test</span>() {
        <span class='kw'>let</span> <span class='ident'>total</span> <span class='op'>=</span> <span class='number'>10</span>;
        <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>task_run_count</span> <span class='op'>=</span> <span class='number'>0</span>;
        <span class='kw'>let</span> <span class='ident'>task_run_count_ptr</span>: <span class='op'>*</span><span class='kw-2'>mut</span> <span class='ident'>uint</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>task_run_count</span>;<span class='comment'>
        // with only one thread this is safe to run in without worries of
        // contention.
        </span><span class='ident'>run</span>(<span class='kw'>proc</span>() {
            <span class='kw'>for</span> _ <span class='kw'>in</span> <span class='ident'>range</span>(<span class='number'>0u</span>, <span class='ident'>total</span>) {
                <span class='ident'>spawn</span>(<span class='kw'>proc</span>() {
                    <span class='kw'>unsafe</span> { <span class='op'>*</span><span class='ident'>task_run_count_ptr</span> <span class='op'>=</span> <span class='op'>*</span><span class='ident'>task_run_count_ptr</span> <span class='op'>+</span> <span class='number'>1</span>};
                });
            }
        });
        <span class='macro'>assert</span><span class='macro'>!</span>(<span class='ident'>task_run_count</span> <span class='op'>==</span> <span class='ident'>total</span>);
    }

    <span class='attribute'>#[<span class='ident'>test</span>]</span>
    <span class='kw'>fn</span> <span class='ident'>multiple_task_nested_test</span>() {
        <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>task_run_count</span> <span class='op'>=</span> <span class='number'>0</span>;
        <span class='kw'>let</span> <span class='ident'>task_run_count_ptr</span>: <span class='op'>*</span><span class='kw-2'>mut</span> <span class='ident'>uint</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>task_run_count</span>;
        <span class='ident'>run</span>(<span class='kw'>proc</span>() {
            <span class='ident'>spawn</span>(<span class='kw'>proc</span>() {
                <span class='kw'>unsafe</span> { <span class='op'>*</span><span class='ident'>task_run_count_ptr</span> <span class='op'>=</span> <span class='op'>*</span><span class='ident'>task_run_count_ptr</span> <span class='op'>+</span> <span class='number'>1</span> };
                <span class='ident'>spawn</span>(<span class='kw'>proc</span>() {
                    <span class='kw'>unsafe</span> { <span class='op'>*</span><span class='ident'>task_run_count_ptr</span> <span class='op'>=</span> <span class='op'>*</span><span class='ident'>task_run_count_ptr</span> <span class='op'>+</span> <span class='number'>1</span> };
                    <span class='ident'>spawn</span>(<span class='kw'>proc</span>() {
                        <span class='kw'>unsafe</span> { <span class='op'>*</span><span class='ident'>task_run_count_ptr</span> <span class='op'>=</span> <span class='op'>*</span><span class='ident'>task_run_count_ptr</span> <span class='op'>+</span> <span class='number'>1</span> };
                    })
                })
            })
        });
        <span class='macro'>assert</span><span class='macro'>!</span>(<span class='ident'>task_run_count</span> <span class='op'>==</span> <span class='number'>3</span>);
    }<span class='comment'>

    // A very simple test that confirms that a task executing on the
    // home scheduler notices that it is home.
    </span><span class='attribute'>#[<span class='ident'>test</span>]</span>
    <span class='kw'>fn</span> <span class='ident'>test_home_sched</span>() {
        <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>pool</span> <span class='op'>=</span> <span class='ident'>pool</span>();

        <span class='kw'>let</span> (<span class='ident'>dtx</span>, <span class='ident'>drx</span>) <span class='op'>=</span> <span class='ident'>channel</span>();
        {
            <span class='kw'>let</span> (<span class='ident'>tx</span>, <span class='ident'>rx</span>) <span class='op'>=</span> <span class='ident'>channel</span>();
            <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>handle1</span> <span class='op'>=</span> <span class='ident'>pool</span>.<span class='ident'>spawn_sched</span>();
            <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>handle2</span> <span class='op'>=</span> <span class='ident'>pool</span>.<span class='ident'>spawn_sched</span>();

            <span class='ident'>handle1</span>.<span class='ident'>send</span>(<span class='ident'>TaskFromFriend</span>(<span class='ident'>pool</span>.<span class='ident'>task</span>(<span class='ident'>TaskOpts</span>::<span class='ident'>new</span>(), <span class='kw'>proc</span>() {
                <span class='ident'>tx</span>.<span class='ident'>send</span>(<span class='ident'>sched_id</span>());
            })));
            <span class='kw'>let</span> <span class='ident'>sched1_id</span> <span class='op'>=</span> <span class='ident'>rx</span>.<span class='ident'>recv</span>();

            <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>task</span> <span class='op'>=</span> <span class='ident'>pool</span>.<span class='ident'>task</span>(<span class='ident'>TaskOpts</span>::<span class='ident'>new</span>(), <span class='kw'>proc</span>() {
                <span class='macro'>assert_eq</span><span class='macro'>!</span>(<span class='ident'>sched_id</span>(), <span class='ident'>sched1_id</span>);
                <span class='ident'>dtx</span>.<span class='ident'>send</span>(());
            });
            <span class='ident'>task</span>.<span class='ident'>give_home</span>(<span class='ident'>HomeSched</span>(<span class='ident'>handle1</span>));
            <span class='ident'>handle2</span>.<span class='ident'>send</span>(<span class='ident'>TaskFromFriend</span>(<span class='ident'>task</span>));
        }
        <span class='ident'>drx</span>.<span class='ident'>recv</span>();

        <span class='ident'>pool</span>.<span class='ident'>shutdown</span>();
    }<span class='comment'>

    // An advanced test that checks all four possible states that a
    // (task,sched) can be in regarding homes.

    </span><span class='attribute'>#[<span class='ident'>test</span>]</span>
    <span class='kw'>fn</span> <span class='ident'>test_schedule_home_states</span>() {
        <span class='kw'>use</span> <span class='ident'>sleeper_list</span>::<span class='ident'>SleeperList</span>;
        <span class='kw'>use</span> <span class='ident'>super</span>::{<span class='ident'>Shutdown</span>, <span class='ident'>Scheduler</span>, <span class='ident'>SchedHandle</span>};
        <span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>rt</span>::<span class='ident'>thread</span>::<span class='ident'>Thread</span>;
        <span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>sync</span>::<span class='ident'>deque</span>::<span class='ident'>BufferPool</span>;

        <span class='ident'>Thread</span>::<span class='ident'>start</span>(<span class='kw'>proc</span>() {
            <span class='kw'>let</span> <span class='ident'>sleepers</span> <span class='op'>=</span> <span class='ident'>SleeperList</span>::<span class='ident'>new</span>();
            <span class='kw'>let</span> <span class='ident'>pool</span> <span class='op'>=</span> <span class='ident'>BufferPool</span>::<span class='ident'>new</span>();
            <span class='kw'>let</span> (<span class='ident'>normal_worker</span>, <span class='ident'>normal_stealer</span>) <span class='op'>=</span> <span class='ident'>pool</span>.<span class='ident'>deque</span>();
            <span class='kw'>let</span> (<span class='ident'>special_worker</span>, <span class='ident'>special_stealer</span>) <span class='op'>=</span> <span class='ident'>pool</span>.<span class='ident'>deque</span>();
            <span class='kw'>let</span> <span class='ident'>queues</span> <span class='op'>=</span> <span class='macro'>vec</span><span class='macro'>!</span>[<span class='ident'>normal_stealer</span>, <span class='ident'>special_stealer</span>];
            <span class='kw'>let</span> (<span class='ident'>_p</span>, <span class='ident'>state</span>) <span class='op'>=</span> <span class='ident'>TaskState</span>::<span class='ident'>new</span>();<span class='comment'>

            // Our normal scheduler
            </span><span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>normal_sched</span> <span class='op'>=</span> <span class='kw'>box</span> <span class='ident'>Scheduler</span>::<span class='ident'>new</span>(
                <span class='number'>1</span>,
                <span class='ident'>basic</span>::<span class='ident'>event_loop</span>(),
                <span class='ident'>normal_worker</span>,
                <span class='ident'>queues</span>.<span class='ident'>clone</span>(),
                <span class='ident'>sleepers</span>.<span class='ident'>clone</span>(),
                <span class='ident'>state</span>.<span class='ident'>clone</span>());

            <span class='kw'>let</span> <span class='ident'>normal_handle</span> <span class='op'>=</span> <span class='ident'>normal_sched</span>.<span class='ident'>make_handle</span>();
            <span class='kw'>let</span> <span class='ident'>friend_handle</span> <span class='op'>=</span> <span class='ident'>normal_sched</span>.<span class='ident'>make_handle</span>();<span class='comment'>

            // Our special scheduler
            </span><span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>special_sched</span> <span class='op'>=</span> <span class='kw'>box</span> <span class='ident'>Scheduler</span>::<span class='ident'>new_special</span>(
                <span class='number'>1</span>,
                <span class='ident'>basic</span>::<span class='ident'>event_loop</span>(),
                <span class='ident'>special_worker</span>,
                <span class='ident'>queues</span>.<span class='ident'>clone</span>(),
                <span class='ident'>sleepers</span>.<span class='ident'>clone</span>(),
                <span class='boolval'>false</span>,
                <span class='prelude-val'>Some</span>(<span class='ident'>friend_handle</span>),
                <span class='ident'>state</span>);

            <span class='kw'>let</span> <span class='ident'>special_handle</span> <span class='op'>=</span> <span class='ident'>special_sched</span>.<span class='ident'>make_handle</span>();

            <span class='kw'>let</span> <span class='ident'>t1_handle</span> <span class='op'>=</span> <span class='ident'>special_sched</span>.<span class='ident'>make_handle</span>();
            <span class='kw'>let</span> <span class='ident'>t4_handle</span> <span class='op'>=</span> <span class='ident'>special_sched</span>.<span class='ident'>make_handle</span>();<span class='comment'>

            // Four test tasks:
            //   1) task is home on special
            //   2) task not homed, sched doesn&#39;t care
            //   3) task not homed, sched requeues
            //   4) task not home, send home

            // Grab both the scheduler and the task from TLS and check if the
            // task is executing on an appropriate scheduler.
            </span><span class='kw'>fn</span> <span class='ident'>on_appropriate_sched</span>() <span class='op'>-&gt;</span> <span class='ident'>bool</span> {
                <span class='kw'>use</span> <span class='ident'>task</span>::{<span class='ident'>TypeGreen</span>, <span class='ident'>TypeSched</span>, <span class='ident'>HomeSched</span>};
                <span class='kw'>let</span> <span class='ident'>task</span> <span class='op'>=</span> <span class='ident'>GreenTask</span>::<span class='ident'>convert</span>(<span class='ident'>Local</span>::<span class='ident'>take</span>());
                <span class='kw'>let</span> <span class='ident'>sched_id</span> <span class='op'>=</span> <span class='ident'>task</span>.<span class='ident'>sched</span>.<span class='ident'>get_ref</span>().<span class='ident'>sched_id</span>();
                <span class='kw'>let</span> <span class='ident'>run_any</span> <span class='op'>=</span> <span class='ident'>task</span>.<span class='ident'>sched</span>.<span class='ident'>get_ref</span>().<span class='ident'>run_anything</span>;
                <span class='kw'>let</span> <span class='ident'>ret</span> <span class='op'>=</span> <span class='kw'>match</span> <span class='ident'>task</span>.<span class='ident'>task_type</span> {
                    <span class='ident'>TypeGreen</span>(<span class='prelude-val'>Some</span>(<span class='ident'>AnySched</span>)) <span class='op'>=&gt;</span> {
                        <span class='ident'>run_any</span>
                    }
                    <span class='ident'>TypeGreen</span>(<span class='prelude-val'>Some</span>(<span class='ident'>HomeSched</span>(<span class='ident'>SchedHandle</span> {
                        <span class='ident'>sched_id</span>: <span class='kw-2'>ref</span> <span class='ident'>id</span>,
                        ..
                    }))) <span class='op'>=&gt;</span> {
                        <span class='op'>*</span><span class='ident'>id</span> <span class='op'>==</span> <span class='ident'>sched_id</span>
                    }
                    <span class='ident'>TypeGreen</span>(<span class='prelude-val'>None</span>) <span class='op'>=&gt;</span> { <span class='macro'>fail</span><span class='macro'>!</span>(<span class='string'>&quot;task without home&quot;</span>); }
                    <span class='ident'>TypeSched</span> <span class='op'>=&gt;</span> { <span class='macro'>fail</span><span class='macro'>!</span>(<span class='string'>&quot;expected green task&quot;</span>); }
                };
                <span class='ident'>task</span>.<span class='ident'>put</span>();
                <span class='ident'>ret</span>
            }

            <span class='kw'>let</span> <span class='ident'>task1</span> <span class='op'>=</span> <span class='ident'>GreenTask</span>::<span class='ident'>new_homed</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>special_sched</span>.<span class='ident'>stack_pool</span>,
                                             <span class='prelude-val'>None</span>, <span class='ident'>HomeSched</span>(<span class='ident'>t1_handle</span>), <span class='kw'>proc</span>() {
                <span class='macro'>rtassert</span><span class='macro'>!</span>(<span class='ident'>on_appropriate_sched</span>());
            });

            <span class='kw'>let</span> <span class='ident'>task2</span> <span class='op'>=</span> <span class='ident'>GreenTask</span>::<span class='ident'>new</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>normal_sched</span>.<span class='ident'>stack_pool</span>, <span class='prelude-val'>None</span>, <span class='kw'>proc</span>() {
                <span class='macro'>rtassert</span><span class='macro'>!</span>(<span class='ident'>on_appropriate_sched</span>());
            });

            <span class='kw'>let</span> <span class='ident'>task3</span> <span class='op'>=</span> <span class='ident'>GreenTask</span>::<span class='ident'>new</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>normal_sched</span>.<span class='ident'>stack_pool</span>, <span class='prelude-val'>None</span>, <span class='kw'>proc</span>() {
                <span class='macro'>rtassert</span><span class='macro'>!</span>(<span class='ident'>on_appropriate_sched</span>());
            });

            <span class='kw'>let</span> <span class='ident'>task4</span> <span class='op'>=</span> <span class='ident'>GreenTask</span>::<span class='ident'>new_homed</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>special_sched</span>.<span class='ident'>stack_pool</span>,
                                             <span class='prelude-val'>None</span>, <span class='ident'>HomeSched</span>(<span class='ident'>t4_handle</span>), <span class='kw'>proc</span>() {
                <span class='macro'>rtassert</span><span class='macro'>!</span>(<span class='ident'>on_appropriate_sched</span>());
            });<span class='comment'>

            // Signal from the special task that we are done.
            </span><span class='kw'>let</span> (<span class='ident'>tx</span>, <span class='ident'>rx</span>) <span class='op'>=</span> <span class='ident'>channel</span>::<span class='op'>&lt;</span>()<span class='op'>&gt;</span>();

            <span class='kw'>fn</span> <span class='ident'>run</span>(<span class='ident'>next</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>GreenTask</span><span class='op'>&gt;</span>) {
                <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>task</span> <span class='op'>=</span> <span class='ident'>GreenTask</span>::<span class='ident'>convert</span>(<span class='ident'>Local</span>::<span class='ident'>take</span>());
                <span class='kw'>let</span> <span class='ident'>sched</span> <span class='op'>=</span> <span class='ident'>task</span>.<span class='ident'>sched</span>.<span class='ident'>take_unwrap</span>();
                <span class='ident'>sched</span>.<span class='ident'>run_task</span>(<span class='ident'>task</span>, <span class='ident'>next</span>)
            }

            <span class='kw'>let</span> <span class='ident'>normal_task</span> <span class='op'>=</span> <span class='ident'>GreenTask</span>::<span class='ident'>new</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>normal_sched</span>.<span class='ident'>stack_pool</span>, <span class='prelude-val'>None</span>, <span class='kw'>proc</span>() {
                <span class='ident'>run</span>(<span class='ident'>task2</span>);
                <span class='ident'>run</span>(<span class='ident'>task4</span>);
                <span class='ident'>rx</span>.<span class='ident'>recv</span>();
                <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>nh</span> <span class='op'>=</span> <span class='ident'>normal_handle</span>;
                <span class='ident'>nh</span>.<span class='ident'>send</span>(<span class='ident'>Shutdown</span>);
                <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>sh</span> <span class='op'>=</span> <span class='ident'>special_handle</span>;
                <span class='ident'>sh</span>.<span class='ident'>send</span>(<span class='ident'>Shutdown</span>);
            });
            <span class='ident'>normal_sched</span>.<span class='ident'>enqueue_task</span>(<span class='ident'>normal_task</span>);

            <span class='kw'>let</span> <span class='ident'>special_task</span> <span class='op'>=</span> <span class='ident'>GreenTask</span>::<span class='ident'>new</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>special_sched</span>.<span class='ident'>stack_pool</span>, <span class='prelude-val'>None</span>, <span class='kw'>proc</span>() {
                <span class='ident'>run</span>(<span class='ident'>task1</span>);
                <span class='ident'>run</span>(<span class='ident'>task3</span>);
                <span class='ident'>tx</span>.<span class='ident'>send</span>(());
            });
            <span class='ident'>special_sched</span>.<span class='ident'>enqueue_task</span>(<span class='ident'>special_task</span>);

            <span class='kw'>let</span> <span class='ident'>normal_sched</span> <span class='op'>=</span> <span class='ident'>normal_sched</span>;
            <span class='kw'>let</span> <span class='ident'>normal_thread</span> <span class='op'>=</span> <span class='ident'>Thread</span>::<span class='ident'>start</span>(<span class='kw'>proc</span>() { <span class='ident'>normal_sched</span>.<span class='ident'>bootstrap</span>() });

            <span class='kw'>let</span> <span class='ident'>special_sched</span> <span class='op'>=</span> <span class='ident'>special_sched</span>;
            <span class='kw'>let</span> <span class='ident'>special_thread</span> <span class='op'>=</span> <span class='ident'>Thread</span>::<span class='ident'>start</span>(<span class='kw'>proc</span>() { <span class='ident'>special_sched</span>.<span class='ident'>bootstrap</span>() });

            <span class='ident'>normal_thread</span>.<span class='ident'>join</span>();
            <span class='ident'>special_thread</span>.<span class='ident'>join</span>();
        }).<span class='ident'>join</span>();
    }<span class='comment'>

    //#[test]
    //fn test_stress_schedule_task_states() {
    //    if util::limit_thread_creation_due_to_osx_and_valgrind() { return; }
    //    let n = stress_factor() * 120;
    //    for _ in range(0, n as int) {
    //        test_schedule_home_states();
    //    }
    //}

    </span><span class='attribute'>#[<span class='ident'>test</span>]</span>
    <span class='kw'>fn</span> <span class='ident'>test_io_callback</span>() {
        <span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>io</span>::<span class='ident'>timer</span>;

        <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>pool</span> <span class='op'>=</span> <span class='ident'>SchedPool</span>::<span class='ident'>new</span>(<span class='ident'>PoolConfig</span> {
            <span class='ident'>threads</span>: <span class='number'>2</span>,
            <span class='ident'>event_loop_factory</span>: <span class='ident'>rustuv</span>::<span class='ident'>event_loop</span>,
        });<span class='comment'>

        // This is a regression test that when there are no schedulable tasks in
        // the work queue, but we are performing I/O, that once we do put
        // something in the work queue again the scheduler picks it up and
        // doesn&#39;t exit before emptying the work queue
        </span><span class='ident'>pool</span>.<span class='ident'>spawn</span>(<span class='ident'>TaskOpts</span>::<span class='ident'>new</span>(), <span class='kw'>proc</span>() {
            <span class='ident'>spawn</span>(<span class='kw'>proc</span>() {
                <span class='ident'>timer</span>::<span class='ident'>sleep</span>(<span class='number'>10</span>);
            });
        });

        <span class='ident'>pool</span>.<span class='ident'>shutdown</span>();
    }

    <span class='attribute'>#[<span class='ident'>test</span>]</span>
    <span class='kw'>fn</span> <span class='ident'>wakeup_across_scheds</span>() {
        <span class='kw'>let</span> (<span class='ident'>tx1</span>, <span class='ident'>rx1</span>) <span class='op'>=</span> <span class='ident'>channel</span>();
        <span class='kw'>let</span> (<span class='ident'>tx2</span>, <span class='ident'>rx2</span>) <span class='op'>=</span> <span class='ident'>channel</span>();

        <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>pool1</span> <span class='op'>=</span> <span class='ident'>pool</span>();
        <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>pool2</span> <span class='op'>=</span> <span class='ident'>pool</span>();

        <span class='ident'>pool1</span>.<span class='ident'>spawn</span>(<span class='ident'>TaskOpts</span>::<span class='ident'>new</span>(), <span class='kw'>proc</span>() {
            <span class='kw'>let</span> <span class='ident'>id</span> <span class='op'>=</span> <span class='ident'>sched_id</span>();
            <span class='ident'>tx1</span>.<span class='ident'>send</span>(());
            <span class='ident'>rx2</span>.<span class='ident'>recv</span>();
            <span class='macro'>assert_eq</span><span class='macro'>!</span>(<span class='ident'>id</span>, <span class='ident'>sched_id</span>());
        });

        <span class='ident'>pool2</span>.<span class='ident'>spawn</span>(<span class='ident'>TaskOpts</span>::<span class='ident'>new</span>(), <span class='kw'>proc</span>() {
            <span class='kw'>let</span> <span class='ident'>id</span> <span class='op'>=</span> <span class='ident'>sched_id</span>();
            <span class='ident'>rx1</span>.<span class='ident'>recv</span>();
            <span class='macro'>assert_eq</span><span class='macro'>!</span>(<span class='ident'>id</span>, <span class='ident'>sched_id</span>());
            <span class='ident'>tx2</span>.<span class='ident'>send</span>(());
        });

        <span class='ident'>pool1</span>.<span class='ident'>shutdown</span>();
        <span class='ident'>pool2</span>.<span class='ident'>shutdown</span>();
    }<span class='comment'>

    // A regression test that the final message is always handled.
    // Used to deadlock because Shutdown was never recvd.
    </span><span class='attribute'>#[<span class='ident'>test</span>]</span>
    <span class='kw'>fn</span> <span class='ident'>no_missed_messages</span>() {
        <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>pool</span> <span class='op'>=</span> <span class='ident'>pool</span>();

        <span class='kw'>let</span> <span class='ident'>task</span> <span class='op'>=</span> <span class='ident'>pool</span>.<span class='ident'>task</span>(<span class='ident'>TaskOpts</span>::<span class='ident'>new</span>(), <span class='kw'>proc</span>()());
        <span class='ident'>pool</span>.<span class='ident'>spawn_sched</span>().<span class='ident'>send</span>(<span class='ident'>TaskFromFriend</span>(<span class='ident'>task</span>));

        <span class='ident'>pool</span>.<span class='ident'>shutdown</span>();
    }

    <span class='attribute'>#[<span class='ident'>test</span>]</span>
    <span class='kw'>fn</span> <span class='ident'>multithreading</span>() {
        <span class='ident'>run</span>(<span class='kw'>proc</span>() {
            <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>rxs</span> <span class='op'>=</span> <span class='macro'>vec</span><span class='macro'>!</span>[];
            <span class='kw'>for</span> _ <span class='kw'>in</span> <span class='ident'>range</span>(<span class='number'>0u</span>, <span class='number'>10</span>) {
                <span class='kw'>let</span> (<span class='ident'>tx</span>, <span class='ident'>rx</span>) <span class='op'>=</span> <span class='ident'>channel</span>();
                <span class='ident'>spawn</span>(<span class='kw'>proc</span>() {
                    <span class='ident'>tx</span>.<span class='ident'>send</span>(());
                });
                <span class='ident'>rxs</span>.<span class='ident'>push</span>(<span class='ident'>rx</span>);
            }

            <span class='kw'>loop</span> {
                <span class='kw'>match</span> <span class='ident'>rxs</span>.<span class='ident'>pop</span>() {
                    <span class='prelude-val'>Some</span>(<span class='ident'>rx</span>) <span class='op'>=&gt;</span> <span class='ident'>rx</span>.<span class='ident'>recv</span>(),
                    <span class='prelude-val'>None</span> <span class='op'>=&gt;</span> <span class='kw'>break</span>,
                }
            }
        });
    }

     <span class='attribute'>#[<span class='ident'>test</span>]</span>
    <span class='kw'>fn</span> <span class='ident'>thread_ring</span>() {
        <span class='ident'>run</span>(<span class='kw'>proc</span>() {
            <span class='kw'>let</span> (<span class='ident'>end_tx</span>, <span class='ident'>end_rx</span>) <span class='op'>=</span> <span class='ident'>channel</span>();

            <span class='kw'>let</span> <span class='ident'>n_tasks</span> <span class='op'>=</span> <span class='number'>10</span>;
            <span class='kw'>let</span> <span class='ident'>token</span> <span class='op'>=</span> <span class='number'>2000</span>;

            <span class='kw'>let</span> (<span class='ident'>tx1</span>, <span class='kw-2'>mut</span> <span class='ident'>rx</span>) <span class='op'>=</span> <span class='ident'>channel</span>();
            <span class='ident'>tx1</span>.<span class='ident'>send</span>((<span class='ident'>token</span>, <span class='ident'>end_tx</span>));
            <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>i</span> <span class='op'>=</span> <span class='number'>2</span>;
            <span class='kw'>while</span> <span class='ident'>i</span> <span class='op'>&lt;=</span> <span class='ident'>n_tasks</span> {
                <span class='kw'>let</span> (<span class='ident'>tx</span>, <span class='ident'>next_rx</span>) <span class='op'>=</span> <span class='ident'>channel</span>();
                <span class='kw'>let</span> <span class='ident'>imm_i</span> <span class='op'>=</span> <span class='ident'>i</span>;
                <span class='kw'>let</span> <span class='ident'>imm_rx</span> <span class='op'>=</span> <span class='ident'>rx</span>;
                <span class='ident'>spawn</span>(<span class='kw'>proc</span>() {
                    <span class='ident'>roundtrip</span>(<span class='ident'>imm_i</span>, <span class='ident'>n_tasks</span>, <span class='kw-2'>&amp;</span><span class='ident'>imm_rx</span>, <span class='kw-2'>&amp;</span><span class='ident'>tx</span>);
                });
                <span class='ident'>rx</span> <span class='op'>=</span> <span class='ident'>next_rx</span>;
                <span class='ident'>i</span> <span class='op'>+=</span> <span class='number'>1</span>;
            }
            <span class='kw'>let</span> <span class='ident'>rx</span> <span class='op'>=</span> <span class='ident'>rx</span>;
            <span class='ident'>spawn</span>(<span class='kw'>proc</span>() {
                <span class='ident'>roundtrip</span>(<span class='number'>1</span>, <span class='ident'>n_tasks</span>, <span class='kw-2'>&amp;</span><span class='ident'>rx</span>, <span class='kw-2'>&amp;</span><span class='ident'>tx1</span>);
            });

            <span class='ident'>end_rx</span>.<span class='ident'>recv</span>();
        });

        <span class='kw'>fn</span> <span class='ident'>roundtrip</span>(<span class='ident'>id</span>: <span class='ident'>int</span>, <span class='ident'>n_tasks</span>: <span class='ident'>int</span>,
                     <span class='ident'>rx</span>: <span class='kw-2'>&amp;</span><span class='ident'>Receiver</span><span class='op'>&lt;</span>(<span class='ident'>int</span>, <span class='ident'>Sender</span><span class='op'>&lt;</span>()<span class='op'>&gt;</span>)<span class='op'>&gt;</span>,
                     <span class='ident'>tx</span>: <span class='kw-2'>&amp;</span><span class='ident'>Sender</span><span class='op'>&lt;</span>(<span class='ident'>int</span>, <span class='ident'>Sender</span><span class='op'>&lt;</span>()<span class='op'>&gt;</span>)<span class='op'>&gt;</span>) {
            <span class='kw'>loop</span> {
                <span class='kw'>match</span> <span class='ident'>rx</span>.<span class='ident'>recv</span>() {
                    (<span class='number'>1</span>, <span class='ident'>end_tx</span>) <span class='op'>=&gt;</span> {
                        <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;{}\n&quot;</span>, <span class='ident'>id</span>);
                        <span class='ident'>end_tx</span>.<span class='ident'>send</span>(());
                        <span class='kw'>return</span>;
                    }
                    (<span class='ident'>token</span>, <span class='ident'>end_tx</span>) <span class='op'>=&gt;</span> {
                        <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;thread: {}   got token: {}&quot;</span>, <span class='ident'>id</span>, <span class='ident'>token</span>);
                        <span class='ident'>tx</span>.<span class='ident'>send</span>((<span class='ident'>token</span> <span class='op'>-</span> <span class='number'>1</span>, <span class='ident'>end_tx</span>));
                        <span class='kw'>if</span> <span class='ident'>token</span> <span class='op'>&lt;=</span> <span class='ident'>n_tasks</span> {
                            <span class='kw'>return</span>;
                        }
                    }
                }
            }
        }
    }

    <span class='attribute'>#[<span class='ident'>test</span>]</span>
    <span class='kw'>fn</span> <span class='ident'>start_closure_dtor</span>() {<span class='comment'>
        // Regression test that the `start` task entrypoint can
        // contain dtors that use task resources
        </span><span class='ident'>run</span>(<span class='kw'>proc</span>() {
            <span class='kw'>struct</span> <span class='ident'>S</span> { <span class='ident'>field</span>: () }

            <span class='kw'>impl</span> <span class='ident'>Drop</span> <span class='kw'>for</span> <span class='ident'>S</span> {
                <span class='kw'>fn</span> <span class='ident'>drop</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>) {
                    <span class='kw'>let</span> <span class='ident'>_foo</span> <span class='op'>=</span> <span class='kw'>box</span> <span class='number'>0i</span>;
                }
            }

            <span class='kw'>let</span> <span class='ident'>s</span> <span class='op'>=</span> <span class='ident'>S</span> { <span class='ident'>field</span>: () };

            <span class='ident'>spawn</span>(<span class='kw'>proc</span>() {
                <span class='kw'>let</span> <span class='ident'>_ss</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='ident'>s</span>;
            });
        });
    }

    <span class='attribute'>#[<span class='ident'>test</span>]</span>
    <span class='kw'>fn</span> <span class='ident'>dont_starve_1</span>() {
        <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>pool</span> <span class='op'>=</span> <span class='ident'>SchedPool</span>::<span class='ident'>new</span>(<span class='ident'>PoolConfig</span> {
            <span class='ident'>threads</span>: <span class='number'>2</span>,<span class='comment'> // this must be &gt; 1
            </span><span class='ident'>event_loop_factory</span>: <span class='ident'>basic</span>::<span class='ident'>event_loop</span>,
        });
        <span class='ident'>pool</span>.<span class='ident'>spawn</span>(<span class='ident'>TaskOpts</span>::<span class='ident'>new</span>(), <span class='kw'>proc</span>() {
            <span class='kw'>let</span> (<span class='ident'>tx</span>, <span class='ident'>rx</span>) <span class='op'>=</span> <span class='ident'>channel</span>();<span class='comment'>

            // This task should not be able to starve the sender;
            // The sender should get stolen to another thread.
            </span><span class='ident'>spawn</span>(<span class='kw'>proc</span>() {
                <span class='kw'>while</span> <span class='ident'>rx</span>.<span class='ident'>try_recv</span>().<span class='ident'>is_err</span>() { }
            });

            <span class='ident'>tx</span>.<span class='ident'>send</span>(());
        });
        <span class='ident'>pool</span>.<span class='ident'>shutdown</span>();
    }

    <span class='attribute'>#[<span class='ident'>test</span>]</span>
    <span class='kw'>fn</span> <span class='ident'>dont_starve_2</span>() {
        <span class='ident'>run</span>(<span class='kw'>proc</span>() {
            <span class='kw'>let</span> (<span class='ident'>tx1</span>, <span class='ident'>rx1</span>) <span class='op'>=</span> <span class='ident'>channel</span>();
            <span class='kw'>let</span> (<span class='ident'>tx2</span>, <span class='ident'>_rx2</span>) <span class='op'>=</span> <span class='ident'>channel</span>();<span class='comment'>

            // This task should not be able to starve the other task.
            // The sends should eventually yield.
            </span><span class='ident'>spawn</span>(<span class='kw'>proc</span>() {
                <span class='kw'>while</span> <span class='ident'>rx1</span>.<span class='ident'>try_recv</span>().<span class='ident'>is_err</span>() {
                    <span class='ident'>tx2</span>.<span class='ident'>send</span>(());
                }
            });

            <span class='ident'>tx1</span>.<span class='ident'>send</span>(());
        });
    }<span class='comment'>

    // Regression test for a logic bug that would cause single-threaded
    // schedulers to sleep forever after yielding and stealing another task.
    </span><span class='attribute'>#[<span class='ident'>test</span>]</span>
    <span class='kw'>fn</span> <span class='ident'>single_threaded_yield</span>() {
        <span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>task</span>::<span class='ident'>deschedule</span>;
        <span class='ident'>run</span>(<span class='kw'>proc</span>() {
            <span class='kw'>for</span> _ <span class='kw'>in</span> <span class='ident'>range</span>(<span class='number'>0u</span>, <span class='number'>5</span>) { <span class='ident'>deschedule</span>(); }
        });
    }

    <span class='attribute'>#[<span class='ident'>test</span>]</span>
    <span class='kw'>fn</span> <span class='ident'>test_spawn_sched_blocking</span>() {
        <span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>rt</span>::<span class='ident'>mutex</span>::{<span class='ident'>StaticNativeMutex</span>, <span class='ident'>NATIVE_MUTEX_INIT</span>};
        <span class='kw'>static</span> <span class='kw-2'>mut</span> <span class='ident'>LOCK</span>: <span class='ident'>StaticNativeMutex</span> <span class='op'>=</span> <span class='ident'>NATIVE_MUTEX_INIT</span>;<span class='comment'>

        // Testing that a task in one scheduler can block in foreign code
        // without affecting other schedulers
        </span><span class='kw'>for</span> _ <span class='kw'>in</span> <span class='ident'>range</span>(<span class='number'>0u</span>, <span class='number'>20</span>) {
            <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>pool</span> <span class='op'>=</span> <span class='ident'>pool</span>();
            <span class='kw'>let</span> (<span class='ident'>start_tx</span>, <span class='ident'>start_rx</span>) <span class='op'>=</span> <span class='ident'>channel</span>();
            <span class='kw'>let</span> (<span class='ident'>fin_tx</span>, <span class='ident'>fin_rx</span>) <span class='op'>=</span> <span class='ident'>channel</span>();

            <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>handle</span> <span class='op'>=</span> <span class='ident'>pool</span>.<span class='ident'>spawn_sched</span>();
            <span class='ident'>handle</span>.<span class='ident'>send</span>(<span class='ident'>PinnedTask</span>(<span class='ident'>pool</span>.<span class='ident'>task</span>(<span class='ident'>TaskOpts</span>::<span class='ident'>new</span>(), <span class='kw'>proc</span>() {
                <span class='kw'>unsafe</span> {
                    <span class='kw'>let</span> <span class='ident'>guard</span> <span class='op'>=</span> <span class='ident'>LOCK</span>.<span class='ident'>lock</span>();

                    <span class='ident'>start_tx</span>.<span class='ident'>send</span>(());
                    <span class='ident'>guard</span>.<span class='ident'>wait</span>();<span class='comment'>   // block the scheduler thread
                    </span><span class='ident'>guard</span>.<span class='ident'>signal</span>();<span class='comment'> // let them know we have the lock
                </span>}

                <span class='ident'>fin_tx</span>.<span class='ident'>send</span>(());
            })));
            <span class='ident'>drop</span>(<span class='ident'>handle</span>);

            <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>handle</span> <span class='op'>=</span> <span class='ident'>pool</span>.<span class='ident'>spawn_sched</span>();
            <span class='ident'>handle</span>.<span class='ident'>send</span>(<span class='ident'>PinnedTask</span>(<span class='ident'>pool</span>.<span class='ident'>task</span>(<span class='ident'>TaskOpts</span>::<span class='ident'>new</span>(), <span class='kw'>proc</span>() {<span class='comment'>
                // Wait until the other task has its lock
                </span><span class='ident'>start_rx</span>.<span class='ident'>recv</span>();

                <span class='kw'>fn</span> <span class='ident'>pingpong</span>(<span class='ident'>po</span>: <span class='kw-2'>&amp;</span><span class='ident'>Receiver</span><span class='op'>&lt;</span><span class='ident'>int</span><span class='op'>&gt;</span>, <span class='ident'>ch</span>: <span class='kw-2'>&amp;</span><span class='ident'>Sender</span><span class='op'>&lt;</span><span class='ident'>int</span><span class='op'>&gt;</span>) {
                    <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>val</span> <span class='op'>=</span> <span class='number'>20</span>;
                    <span class='kw'>while</span> <span class='ident'>val</span> <span class='op'>&gt;</span> <span class='number'>0</span> {
                        <span class='ident'>val</span> <span class='op'>=</span> <span class='ident'>po</span>.<span class='ident'>recv</span>();
                        <span class='kw'>let</span> _ <span class='op'>=</span> <span class='ident'>ch</span>.<span class='ident'>send_opt</span>(<span class='ident'>val</span> <span class='op'>-</span> <span class='number'>1</span>);
                    }
                }

                <span class='kw'>let</span> (<span class='ident'>setup_tx</span>, <span class='ident'>setup_rx</span>) <span class='op'>=</span> <span class='ident'>channel</span>();
                <span class='kw'>let</span> (<span class='ident'>parent_tx</span>, <span class='ident'>parent_rx</span>) <span class='op'>=</span> <span class='ident'>channel</span>();
                <span class='ident'>spawn</span>(<span class='kw'>proc</span>() {
                    <span class='kw'>let</span> (<span class='ident'>child_tx</span>, <span class='ident'>child_rx</span>) <span class='op'>=</span> <span class='ident'>channel</span>();
                    <span class='ident'>setup_tx</span>.<span class='ident'>send</span>(<span class='ident'>child_tx</span>);
                    <span class='ident'>pingpong</span>(<span class='kw-2'>&amp;</span><span class='ident'>child_rx</span>, <span class='kw-2'>&amp;</span><span class='ident'>parent_tx</span>);
                });

                <span class='kw'>let</span> <span class='ident'>child_tx</span> <span class='op'>=</span> <span class='ident'>setup_rx</span>.<span class='ident'>recv</span>();
                <span class='ident'>child_tx</span>.<span class='ident'>send</span>(<span class='number'>20</span>);
                <span class='ident'>pingpong</span>(<span class='kw-2'>&amp;</span><span class='ident'>parent_rx</span>, <span class='kw-2'>&amp;</span><span class='ident'>child_tx</span>);
                <span class='kw'>unsafe</span> {
                    <span class='kw'>let</span> <span class='ident'>guard</span> <span class='op'>=</span> <span class='ident'>LOCK</span>.<span class='ident'>lock</span>();
                    <span class='ident'>guard</span>.<span class='ident'>signal</span>();<span class='comment'>   // wakeup waiting scheduler
                    </span><span class='ident'>guard</span>.<span class='ident'>wait</span>();<span class='comment'>     // wait for them to grab the lock
                </span>}
            })));
            <span class='ident'>drop</span>(<span class='ident'>handle</span>);

            <span class='ident'>fin_rx</span>.<span class='ident'>recv</span>();
            <span class='ident'>pool</span>.<span class='ident'>shutdown</span>();
        }
        <span class='kw'>unsafe</span> { <span class='ident'>LOCK</span>.<span class='ident'>destroy</span>(); }
    }
}
</pre>
</section>
    <section id='search' class="content hidden"></section>

    <section class="footer"></section>

    <div id="help" class="hidden">
        <div class="shortcuts">
            <h1>Keyboard shortcuts</h1>
            <dl>
                <dt>?</dt>
                <dd>Show this help dialog</dd>
                <dt>S</dt>
                <dd>Focus the search field</dd>
                <dt>&larrb;</dt>
                <dd>Move up in search results</dd>
                <dt>&rarrb;</dt>
                <dd>Move down in search results</dd>
                <dt>&#9166;</dt>
                <dd>Go to active search result</dd>
            </dl>
        </div>
        <div class="infos">
            <h1>Search tricks</h1>
            <p>
                Prefix searches with a type followed by a colon (e.g.
                <code>fn:</code>) to restrict the search to a given type.
            </p>
            <p>
                Accepted types are: <code>fn</code>, <code>mod</code>,
                <code>struct</code> (or <code>str</code>), <code>enum</code>,
                <code>trait</code>, <code>typedef</code> (or
                <code>tdef</code>).
            </p>
        </div>
    </div>

    

    <script>
        window.rootPath = "../../../../../../../../../";
        window.currentCrate = "green";
        window.playgroundUrl = "http://play.rust-lang.org/";
    </script>
    <script src="../../../../../../../../../jquery.js"></script>
    <script src="../../../../../../../../../main.js"></script>
    <script src="../../../../../../../../../playpen.js"></script>
    <script async src="../../../../../../../../../search-index.js"></script>
</body>
</html>